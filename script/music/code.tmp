
-- -----------------------------------------------------------------
-- Init
-- -----------------------------------------------------------------
local function prog_init()
    initModels()
    sound_playMusic("music/-----")
    local pokus = getRestartCount()


    -- -------------------------------------------------------------
    local function prog_init_room()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        room.hlaskam = 0
        room.hlaskav = 0
        if roompole[0] == 0 then
            roompole[0] = music_volume
        end
        room.rozbito = 0

        return function()
            if isReady(small) and isReady(big) and no_dialog() then
                if playing(50) or playing(51) or playing(52) then
                    if room.hlaskam == 0 and random(1000) < 1 then
                        room.hlaskam = 1
                        addm(10, "ves-m-krab")
                    elseif room.hlaskav == 0 and random(1000) < 2 then
                        room.hlaskav = 1
                        switch(random(2)){
                            [0] = function()
                                addv(10, "ves-v-veci")
                            end,
                            [1] = function()
                                addv(10, "ves-v-vyp")
                            end,
                        }
                    elseif roompole[0] > music_volume and music_volume < 16 then
                        roompole[0] = 0
                        addm(15, "ves-m-dik")
                        addv(random(20) + 10, "ves-v-stejne")
                    end
                elseif room.rozbito == 3 then
                    room.rozbito = room.rozbito + 1
                    addv(10, "ves-v-pokoj")
                elseif room.rozbito == 5 then
                    addm(3, "ves-m-uz")
                    room.rozbito = room.rozbito + 1
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_amp1()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        amp1.stav = 0

        return function()
            if amp1.stav == 1 and count == 2 and not playing(50) then
                musiccyc("ves-ampliony", 50)
            end
            switch(amp1.stav){
                [0] = function()
                    if count == hlava.zac2 then
                        amp1.faze = 0
                        musiccyc("ves-ampliony", 50)
                        amp1.stav = amp1.stav + 1
                    end
                end,
                [1] = function()
                    if Dir == dir_down then
                        amp1.stav = amp1.stav + 1
                        amp1.afaze = 7
                    elseif odd(count) then
                        switch(amp1.faze){
                            [0, 3, 4, 7, 12] = function()
                                amp1.afaze = amp1.afaze + 1
                            end,
                            [1, 6, 9, 10] = function()
                                amp1.afaze = amp1.afaze - 1
                            end,
                            [2, 5] = function()
                                inc(amp1.afaze, 2)
                            end,
                            [8, 11] = function()
                                dec(amp1.afaze, 2)
                            end,
                            [13] = function()
                                amp1.faze = -1
                                amp1.afaze = 0
                            end,
                        }
                        amp1.faze = amp1.faze + 1
                    end
                end,
                [2] = function()
                    if Dir ~= dir_down then
                        ksnd(50)
                        snd("sp-smrt", 40)
                        amp1.afaze = 9
                        amp1.stav = amp1.stav + 1
                        room.rozbito = room.rozbito + 1
                    elseif odd(count) then
                        amp1.afaze = 15 - amp1.afaze
                    end
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_amp2()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        amp2.stav = 0
        amp2.afaze = 3

        return function()
            if amp2.stav == 1 and count == 2 + 3 and not playing(51) then
                musiccyc("ves-ampliony", 51)
            end
            switch(amp2.stav){
                [0] = function()
                    if count == hlava.zac2 + 3 then
                        amp2.faze = 4
                        musiccyc("ves-ampliony", 51)
                        amp2.stav = amp2.stav + 1
                    end
                end,
                [1] = function()
                    if Dir == dir_down then
                        amp2.stav = amp2.stav + 1
                        amp2.afaze = 7
                    elseif odd(count) then
                        switch(amp2.faze){
                            [0, 3, 4, 7, 12] = function()
                                amp2.afaze = amp2.afaze + 1
                            end,
                            [1, 6, 9, 10] = function()
                                amp2.afaze = amp2.afaze - 1
                            end,
                            [2, 5] = function()
                                inc(amp2.afaze, 2)
                            end,
                            [8, 11] = function()
                                dec(amp2.afaze, 2)
                            end,
                            [13] = function()
                                amp2.faze = -1
                                amp2.afaze = 0
                            end,
                        }
                        amp2.faze = amp2.faze + 1
                    end
                end,
                [2] = function()
                    if Dir ~= dir_down then
                        ksnd(51)
                        snd("sp-smrt", 40)
                        amp2.afaze = 9
                        amp2.stav = amp2.stav + 1
                        room.rozbito = room.rozbito + 1
                    elseif odd(count) then
                        amp2.afaze = 15 - amp2.afaze
                    end
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_amp3()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        amp3.stav = 0
        amp3.afaze = 6

        return function()
            if amp3.stav == 1 and count == 2 + 5 and not playing(52) then
                musiccyc("ves-ampliony", 52)
            end
            switch(amp3.stav){
                [0] = function()
                    if count == hlava.zac2 + 5 then
                        amp3.faze = 6
                        musiccyc("ves-ampliony", 52)
                        amp3.stav = amp3.stav + 1
                    end
                end,
                [1] = function()
                    if Dir == dir_down then
                        amp3.stav = amp3.stav + 1
                        amp3.afaze = 7
                    elseif odd(count) then
                        switch(amp3.faze){
                            [0, 3, 4, 7, 12] = function()
                                amp3.afaze = amp3.afaze + 1
                            end,
                            [1, 6, 9, 10] = function()
                                amp3.afaze = amp3.afaze - 1
                            end,
                            [2, 5] = function()
                                inc(amp3.afaze, 2)
                            end,
                            [8, 11] = function()
                                dec(amp3.afaze, 2)
                            end,
                            [13] = function()
                                amp3.faze = -1
                                amp3.afaze = 0
                            end,
                        }
                        amp3.faze = amp3.faze + 1
                    end
                end,
                [2] = function()
                    if Dir ~= dir_down then
                        ksnd(52)
                        snd("sp-smrt", 40)
                        amp3.afaze = 9
                        amp3.stav = amp3.stav + 1
                        room.rozbito = room.rozbito + 1
                    elseif odd(count) then
                        amp3.afaze = 15 - amp3.afaze
                    end
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_hlava()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        hlava.stav = 0
        hlava.zac1 = 30
        hlava.zac2 = 65

        return function()
            switch(hlava.stav){
                [0] = function()
                    if count == hlava.zac1 then
                        hlava.stav = hlava.stav + 1
                        snd("ves-hs-hrajeme", 301)
                    end
                end,
                [1] = function()
                    if playing(301) then
                        switch(random(3)){
                            [0] = function()
                                hlava.afaze = 0
                            end,
                            [1] = function()
                                hlava.afaze = 17
                            end,
                            [2] = function()
                                hlava.afaze = 14
                            end,
                        }
                    else
                        hlava.stav = hlava.stav + 1
                        hlava.afaze = 5
                    end
                end,
                [2] = function()
                    if count >= hlava.zac2 + 10 then
                        hlava.stav = hlava.stav + 1
                    end
                end,
                [3] = function()
                    if room.rozbito < 3 then
                        if odd(math.floor(count / 2)) then
                            hlava.afaze = 10
                        else
                            hlava.afaze = 11
                        end
                    else
                        hlava.afaze = 13
                        hlava.stav = hlava.stav + 1
                    end
                end,
                [4.. --FIXME: range
50] = function()
                    hlava.stav = hlava.stav + 1
                end,
                [51] = function()
                    talk("ves-hs-papa", 302)
                    room.rozbito = room.rozbito + 1
                    hlava.stav = 100
                end,
                [100] = function()
                    if playing(302) then
                        if odd(math.floor(count / 2)) then
                            hlava.afaze = 4
                        else
                            hlava.afaze = 18
                        end
                    else
                        room.rozbito = room.rozbito + 1
                        hlava.afaze = 5
                        hlava.stav = hlava.stav + 1
                    end
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_krabik()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        krabik.afaze = 1

        return function()
            if playing(50) or playing(51) or playing(52) or playing(302) then
                krabik.afaze = random(5)
                if krabik.afaze == 1 then
                    krabik.afaze = 5
                end
            elseif random(20) == 0 then
                krabik.afaze = 1
            end
        end
    end

    -- --------------------
    local update_table = {}
    local subinit
    subinit = prog_init_room()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_amp1()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_amp2()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_amp3()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_hlava()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_krabik()
    if subinit then
        table.insert(update_table, subinit)
    end
    return update_table
end
local update_table = prog_init()


-- -----------------------------------------------------------------
-- Update
-- -----------------------------------------------------------------
function prog_update()
    for key, subupdate in pairs(update_table) do
        subupdate()
    end
end

