
-- -----------------------------------------------------------------
-- Init
-- -----------------------------------------------------------------
local function prog_init()
    initModels()
    sound_playMusic("music/rybky01.ogg")
    local pokus = getRestartCount()


    -- -------------------------------------------------------------
    local function prog_init_room()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        gspec = 9
        room.stavhry = 0
        room.posl = 0
        room.uvod = 0
        room.costim = nah(25, 100)
        room.oholi = 0
        room.opalce = 0
        room.omicich = nah(1200, 4000)
        room.shodit = -1

        return function()
            if StdKrajniHlaska then
                addm(random(10) + 5, "lod-m-bohove")
                StdKonecKrajniHlasky()
            end
            if isReady(small) and isReady(big) and no_dialog() then
                if room.costim > 0 then
                    room.costim = room.costim - 1
                end
                if room.omicich > 0 then
                    room.omicich = room.omicich - 1
                end
                if room.uvod == 0 then
                    room.uvod = 1
                    switch(random(3)){
                        [0] = function()
                            addv(nah(10, 20), "lod-v-silenost0")
                        end,
                        [1] = function()
                            addv(nah(10, 20), "lod-v-silenost1")
                        end,
                        [2] = function()
                            addv(nah(10, 20), "lod-v-silenost2")
                        end,
                    }
                    switch(random(3)){
                        [0] = function()
                            addm(random(5), "lod-m-pravda0")
                        end,
                        [1] = function()
                            addm(random(5), "lod-m-pravda1")
                        end,
                        [2] = function()
                            addm(random(5), "lod-m-pravda2")
                        end,
                    }
                elseif room.costim == 0 then
                    room.costim = -1
                    switch(random(2)){
                        [0] = function()
                            addm(random(5), "lod-m-cos" + "tim")
                            addv(random(5), "lod-v-internovat")
                            addm(random(5), "lod-m-co")
                            addv(random(5), "lod-v-cvok")
                            addm(random(5), "lod-m-oba")
                            addv(random(5), "lod-v-golf")
                            addm(random(5), "lod-m-jednoho")
                        end,
                        [1] = function()
                            addm(random(5), "lod-m-cos" + "tim")
                            addv(random(5), "lod-v-internovat")
                            addm(random(5), "lod-m-oba")
                            addv(random(5), "lod-v-golf")
                            addm(random(5), "lod-m-jednoho")
                        end,
                    }
                    addv(random(7), "lod-v-koho")
                    switch(random(2)){
                        [0] = function()
                            addset(big.hlaska, 1)
                            addm(random(3), "lod-m-zluty")
                        end,
                        [1] = function()
                            addset(big.hlaska, 2)
                            addm(random(3), "lod-m-modry")
                        end,
                    }
                    switch(random(2)){
                        [0] = function()
                            addm(random(5), "lod-m-hrac")
                        end,
                        [1] = function()
                            addv(random(5), "lod-v-hrac")
                        end,
                    }
                elseif room.oholi == 0 and hul.dir ~= dir_no and aktivni == velka and random(100) < 1 then
                    room.oholi = 1
                    addv(0, "lod-v-hul")
                    addm(random(7), "lod-m-ozizlana")
                elseif room.opalce == 0 and random(1000) < 1 then
                    room.opalce = 1
                    addv(random(10), "lod-v-hravost")
                    if palka.x == 23 and palka.y == 2 then
                        addm(random(7), "lod-m-pal" + "ka")
                    end
                elseif room.omicich == 0 then
                    if kriketak.x > 24 and kriketak.y > 19 then
                        addv(random(5), "lod-v-micky")
                        addm(random(5), "lod-m-vyznam")
                        addv(random(5), "lod-v-kdovi")
                    end
                    addm(random(5), "lod-m-micek")
                    addv(random(5), "lod-v-rozliseni")
                end
            end
            switch(room.stavhry){
                [0] = function()
                    initlode()
                    buh1.lodi = nlodi
                    buh2.lodi = nlodi
                    room.hraje = 1
                    room.stavhry = room.stavhry + 1
                    room.cekani = random(10) + 5
                end,
                [1] = function()
                    if no_dialog() then
                        if room.cekani > 0 then
                            room.cekani = room.cekani - 1
                        else
                            switch(room.hraje){
                                [1] = function()
                                    buh1.cinnost = 1
                                end,
                                [2] = function()
                                    buh2.cinnost = 1
                                end,
                            }
                            room.stavhry = 2
                        end
                    end
                end,
                [2] = function()
                    room.stavhry = 1
                    if buh2.lodi == 0 then
                        addd(3, "b2-vyhral", 201, buh2.mluveni)
                        room.stavhry = 3
                    end
                    if buh1.lodi == 0 then
                        addd(8, "b1-vyhral", 101, buh1.mluveni)
                        room.stavhry = 3
                    end
                    if room.stavhry == 1 then
                        room.cekani = random(10) + 5
                    else
                        room.cekani = random(100) + 100
                        switch(random(2)){
                            [0] = function()
                                addd(random(30) + 10, "b2-znovu", 201, buh2.mluveni)
                                addd(random(10) + 5, "b1-dobre", 101, buh1.mluveni)
                            end,
                            [1] = function()
                                addd(random(30) + 10, "b1-znovu", 101, buh1.mluveni)
                                addd(random(10) + 5, "b2-dobre", 201, buh2.mluveni)
                            end,
                        }
                    end
                end,
                [3] = function()
                    if no_dialog() then
                        if room.cekani > 0 then
                            room.cekani = room.cekani - 1
                        else
                            addd(0, "b1-zacinam", 101, buh1.mluveni)
                            room.stavhry = 0
                        end
                    end
                end,
            }
            if room.shodit >= 0 then
                shodLod(room.shodit)
                room.shodit = -1
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_buh2()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        buh2.cinnost = 0
        buh2.mluveni = 0
        buh2.cinruky = 0
        buh2.ruka = 0

        return function()
            Spec9(this, 6, 6)
            switch(buh2.cinnost){
                [1] = function()
                    pom1 = hrajlode(2, buh2.x, buh2.y)
                    buh2.cekat = random(10) + 5
                    globtit = chr(buh2.y - 1 + ord("A")) + IntToStr(buh2.x)
                    addd(buh2.cekat, "b2-" + chr(buh2.y - 1 + ord("a")), 201, buh2.mluveni)
                    buh2.cinnost = 2
                    buh2.cekat = buh2.cekat + random(4) + 9
                    switch(pom1){
                        [1] = function()
                            adddel(random(20) + 20)
                            addset(buh1.cinruky, random(3) + 1)
                            addd(0, "b1-voda" + intToStr(random(5) + 1), 102, buh1.mluveni)
                            addset(buh2.cinruky, random(3) + 1)
                            room.hraje = 1
                        end,
                        [3] = function()
                            adddel(random(20) + 20)
                            addset(buh1.cinruky, random(3) + 3)
                            addd(0, "b1-zasah" + intToStr(random(4) + 1), 103, buh1.mluveni)
                            addset(buh2.cinruky, random(3) + 3)
                        end,
                        [4] = function()
                            adddel(random(20) + 20)
                            addset(buh1.cinruky, random(3) + 1)
                            addd(0, "b1-potop" + intToStr(random(3) + 1), 104, buh1.mluveni)
                            addset(buh1.cinruky, -random(10) - 5)
                            addset(buh2.cinruky, -random(10) - 5)
                            buh2.lodi = buh2.lodi - 1
                            addset(room.shodit, posltrefena)
                        end,
                        [5] = function()
                            addd(random(20) + 20, "b1-voda" + intToStr(random(5) + 1), 102, buh1.mluveni)
                            adddel(5)
                            addset(buh2.mluveni, 3)
                            addd(10 + random(10), "b2-podvadis", 220, buh2.mluveni)
                            addd(8, "b2-" + chr(buh2.y - 1 + ord("a")), 220, buh2.mluveni)
                            addd(0, "b2-" + IntToStr(buh2.x), 220, buh2.mluveni)
                            addd(0, "b2-nemuze", 220, buh2.mluveni)
                            addd(random(30) + 10, "b1-spletl", 105, buh1.mluveni)
                            addd(random(5) + 5, "b1-potop" + inttostr(random(3) + 1), 104, buh1.mluveni)
                            buh2.lodi = buh2.lodi - 1
                            addset(room.shodit, posltrefena)
                        end,
                        [6] = function()
                            addd(random(20) + 20, "b1-zasah" + intToStr(random(4) + 1), 103, buh1.mluveni)
                            addd(random(10), "b2-podvadis", 220, buh2.mluveni)
                            addd(random(10), "b2-spatne", 220, buh2.mluveni)
                            switch(random(2)){
                                [0] = function()
                                    addd(random(30) + 10, "b1-spletl", 105, buh1.mluveni)
                                end,
                                [1] = function()
                                    addd(random(5) + 2, "b1-nepodvadim", 106, buh1.mluveni)
                                end,
                            }
                        end,
                        [7] = function()
                            addd(random(20) + 20, "b1-potop" + intToStr(random(3) + 1), 104, buh1.mluveni)
                            addd(random(10), "b2-podvadis", 220, buh2.mluveni)
                            addd(random(10), "b2-spatne", 220, buh2.mluveni)
                            switch(random(2)){
                                [0] = function()
                                    addd(random(30) + 10, "b1-spletl", 105, buh1.mluveni)
                                end,
                                [1] = function()
                                    addd(random(5) + 2, "b1-nepodvadim", 106, buh1.mluveni)
                                end,
                            }
                            buh2.lodi = buh2.lodi - 1
                            addset(room.shodit, posltrefena)
                        end,
                    }
                end,
                [2] = function()
                    if buh2.cekat > 0 then
                        buh2.cekat = buh2.cekat - 1
                    else
                        talk("b2-" + intToStr(buh2.x), 201)
                        buh2.cinnost = 0
                    end
                end,
            }
            switch(buh2.mluveni){
                [0] = function()
                    if not (buh2.xicht IN --FIXME: IN
{3.. --FIXME: range
4, 6.. --FIXME: range
7}) or random(100) < 4 then
                        buh2.xicht = random(6) + 3
                        if buh2.xicht == 5 or buh2.xicht == 8 then
                            buh2.xicht = 3
                        end
                    end
                end,
                [1] = function()
                    if not (buh2.xicht IN --FIXME: IN
{8, 9}) or random(100) < 3 then
                        buh2.xicht = 8 + random(2)
                        buh2.afaze = buh2.xicht + buh2.ruka * 10
                    end
                end,
                [2] = function()
                    if not (buh2.xicht IN --FIXME: IN
{0, 1}) or random(100) < 5 then
                        buh2.xicht = random(2)
                    end
                end,
                [3] = function()
                    if not (buh2.xicht IN --FIXME: IN
{1, 2}) or random(100) < 5 then
                        buh2.xicht = random(2) + 1
                    end
                end,
                [200.. --FIXME: range
219] = function()
                    if odd(count) then
                        buh2.xicht = random(3)
                    end
                end,
                [220] = function()
                    if buh2.xicht == 5 then
                        buh2.xicht = 6
                    else
                        buh2.xicht = 5
                    end
                end,
            }
            switch(buh2.mluveni){
                [0, 1, 200.. --FIXME: range
220] = function()
                    if buh2.ruka > 3 then
                        buh2.ruka = random(4)
                    end
                    if buh2.cinruky == 0 then
                        if random(100) < 2 then
                            buh2.ruka = random(4)
                        end
                    elseif buh2.cinruky > 0 then
                        if math.mod(count, 3) == 0 then
                            if random(100) < 30 then
                                buh2.ruka = (buh2.ruka XOR --FIXME: XOR
1)
                            else
                                buh2.ruka = (buh2.ruka XOR --FIXME: XOR
2)
                            end
                            buh2.cinruky = buh2.cinruky - 1
                        end
                    else
                        if random(100) < 30 then
                            buh2.ruka = (buh2.ruka XOR --FIXME: XOR
1)
                        else
                            buh2.ruka = (buh2.ruka XOR --FIXME: XOR
2)
                        end
                        buh2.cinruky = buh2.cinruky + 1
                    end
                    buh2.afaze = buh2.ruka * 10 + buh2.xicht
                end,
                [2, 3] = function()
                    if not (buh2.ruka IN --FIXME: IN
{4.. --FIXME: range
6}) or odd(count) and random(100) < 30 then
                        buh2.ruka = random(3) + 4
                    end
                    if buh2.ruka == 4 then
                        switch(buh2.xicht){
                            [0] = function()
                                buh2.afaze = 0
                            end,
                            [1] = function()
                                buh2.afaze = 6
                            end,
                            [2] = function()
                                buh2.afaze = 9
                            end,
                        }
                    else
                        buh2.afaze = buh2.ruka * 3 + 25 + buh2.xicht
                    end
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_buh1()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        buh1.cinnost = 0
        buh1.ruka = 0
        buh1.oci = 0
        buh1.pusa = 0
        buh1.mluveni = 0
        buh1.cinruky = 0

        return function()
            Spec9(this, 5, 6)
            switch(buh1.cinnost){
                [1] = function()
                    pom1 = hrajlode(1, buh1.x, buh1.y)
                    buh1.cekat = random(10) + 5
                    globtit = chr(buh1.y - 1 + ord("A")) + IntToStr(buh1.x)
                    addd(buh1.cekat, "b1-" + chr(buh1.y - 1 + ord("a")), 101, buh1.mluveni)
                    buh1.cinnost = 2
                    buh1.cekat = buh1.cekat + random(4) + 9
                    switch(pom1){
                        [1] = function()
                            adddel(random(20) + 20)
                            addset(buh2.cinruky, random(2) + 1)
                            addd(0, "b2-voda" + intToStr(random(5) + 1), 202, buh2.mluveni)
                            addset(buh1.cinruky, random(2) + 1)
                            room.hraje = 2
                        end,
                        [3] = function()
                            adddel(random(20) + 20)
                            addset(buh2.cinruky, random(3) + 2)
                            addd(0, "b2-zasah" + intToStr(random(4) + 1), 203, buh2.mluveni)
                            if random(3) == 0 then
                                addset(buh2.mluveni, 1)
                            end
                            addset(buh1.cinruky, random(3) + 2)
                        end,
                        [4] = function()
                            adddel(random(20) + 20)
                            addset(buh2.cinruky, random(3) + 1)
                            addd(0, "b2-potop" + intToStr(random(3) + 1), 204, buh2.mluveni)
                            if random(3) ~= 0 then
                                addset(buh2.mluveni, 1)
                            end
                            addset(buh1.cinruky, -random(7) - 5)
                            addset(buh2.cinruky, -random(7) - 5)
                            buh1.lodi = buh1.lodi - 1
                            addset(room.shodit, posltrefena)
                        end,
                        [8] = function()
                            adddel(10 + random(10))
                            addset(buh2.mluveni, 2)
                            addd(random(15) + 10, "b2-rikal" + intToStr(random(2) + 1), 205, buh2.mluveni)
                            addd(1, "b2-voda1", 201, buh2.mluveni)
                            room.hraje = 2
                        end,
                        [9] = function()
                            adddel(10 + random(10))
                            addset(buh2.mluveni, 2)
                            addd(random(15) + 10, "b2-rikal" + intToStr(random(2) + 1), 201, buh2.mluveni)
                        end,
                    }
                end,
                [2] = function()
                    if buh1.cekat > 0 then
                        buh1.cekat = buh1.cekat - 1
                    else
                        talk("b1-" + intToStr(buh1.x), 101)
                        buh1.cinnost = 0
                    end
                end,
            }
            if buh1.mluveni > 100 then
                if odd(count) and buh1.mluveni > 101 or math.mod(count, 4) == 1 then
                    if random(2) == 1 then
                        buh1.pusa = math.mod(buh1.pusa + 1, 3)
                    else
                        buh1.pusa = math.mod(buh1.pusa + 2, 3)
                    end
                end
            end
            switch(buh1.mluveni){
                [0] = function()
                    if buh2.mluveni > 0 then
                        buh1.pusa = 0
                    else
                        buh1.pusa = 0
                    end
                    if random(100) < 3 then
                        buh1.oci = random(2)
                    end
                end,
                [101, 102] = function()
                    if room.posl ~= buh1.mluveni then
                        buh1.oci = math.floor(random(3) / 2)
                    elseif random(100) < 3 then
                        buh1.oci = 1 - buh1.oci
                    end
                    room.posl = buh1.mluveni
                end,
                [103, 104] = function()
                    if room.posl ~= buh1.mluveni then
                        buh1.oci = 2 - math.floor(random(3) / 2)
                    elseif random(100) < 3 then
                        buh1.oci = 3 - buh1.oci
                    end
                    room.posl = buh1.mluveni
                end,
                [105] = function()
                    if room.posl ~= buh1.mluveni then
                        buh1.oci = 0
                    end
                    room.posl = buh1.mluveni
                end,
                [106] = function()
                    if room.posl ~= buh1.mluveni then
                        buh1.oci = 2
                    end
                    room.posl = buh1.mluveni
                end,
            }
            if buh1.cinruky == 0 then
                if random(100) < 4 then
                    buh1.ruka = random(4)
                end
            elseif buh1.cinruky > 0 then
                if math.mod(count, 2) == 0 then
                    pom1 = random(3)
                    if pom1 == buh1.ruka then
                        pom1 = 3
                    end
                    buh1.ruka = pom1
                    buh1.cinruky = buh1.cinruky - 1
                end
            else
                pom1 = random(3)
                if pom1 == buh1.ruka then
                    pom1 = 3
                end
                buh1.ruka = pom1
                buh1.cinruky = buh1.cinruky + 1
            end
            buh1.afaze = buh1.ruka * 12 + buh1.oci * 4 + buh1.pusa
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_big()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        big.hlaska = 0

        return function()
            switch(big.hlaska){
                [1] = function()
                    talk("lod-v-modry", velka)
                end,
                [2] = function()
                    talk("lod-v-zluty", velka)
                end,
            }
            big.hlaska = 0
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_objekty()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        spec = 11

    end

    -- -------------------------------------------------------------
    local function prog_init_maska()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        spec = 11

    end

    -- --------------------
    local update_table = {}
    local subinit
    subinit = prog_init_room()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_buh2()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_buh1()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_big()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_objekty()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_maska()
    if subinit then
        table.insert(update_table, subinit)
    end
    return update_table
end
local update_table = prog_init()


-- -----------------------------------------------------------------
-- Update
-- -----------------------------------------------------------------
function prog_update()
    for key, subupdate in pairs(update_table) do
        subupdate()
    end
end

