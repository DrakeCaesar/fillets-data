
-- -----------------------------------------------------------------
-- Init
-- -----------------------------------------------------------------
local function prog_init()
    initModels()
    sound_playMusic("music/rybky03.ogg")
    local pokus = getRestartCount()


    -- -------------------------------------------------------------
    local function prog_init_room()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        room.qnevsimla = 0
        room.qautomat = 0
        room.qnezkusime = 0
        room.qhlava = 0
        room.komentovaly = 0

        return function()
            if isReady(small) and isReady(big) and no_dialog() and vladce.cinnost == 0 and not playing(302) then
                if room.komentovaly < vladce.promluvila then
                    room.komentovaly = vladce.promluvila
                    if room.komentovaly > 1 and random(100) < 50 then
                        switch(random(4)){
                            [0] = function()
                                room.qnevsimla = math.mod(room.qnevsimla + 1, 4)
                                if room.qnevsimla == 1 then
                                    addv(8, "vit-v-nevsimla")
                                end
                            end,
                            [1] = function()
                                room.qautomat = math.mod(room.qautomat + 1, 6)
                                if room.qautomat == 1 then
                                    addv(8, "vit-v-automat")
                                    addm(9, "vit-m-nebo")
                                end
                            end,
                            [2] = function()
                                room.qnezkusime = math.mod(room.qnezkusime + 1, 8)
                                if room.qnezkusime == 2 then
                                    addm(8, "vit-m-nezkusime")
                                    if room.komentovaly < 15 then
                                        addv(5, "vit-v-proc")
                                    end
                                end
                            end,
                            [3] = function()
                                room.qhlava = math.mod(room.qhlava + 1, 2)
                                if room.qautomat == 0 then
                                    switch(random(2)){
                                        [0] = function()
                                            addm(8, "vit-m-hlava")
                                        end,
                                        [1] = function()
                                            addv(8, "vit-v-hlava")
                                        end,
                                    }
                                end
                            end,
                        }
                    end
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_vladce()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        vladce.promluvila = 0
        vladce.delay = random(80) + 80
        vladce.ksichty = 0
        vladce.vital = 0
        vladce.obecne = 0
        vladce.specialni = 0
        vladce.prodleva = 100
        vladce.cinnost = 0

        return function()
            vladce.afaze = vladce.afaze + 1
            if vladce.obecne == 31 and vladce.specialni == 31 then
                vladce.prodleva = 2 * vladce.prodleva
                vladce.obecne = 0
                vladce.specialni = 0
            end
            if vladce.delay < 0 then
                vladce.delay = random(vladce.prodleva) + vladce.prodleva
            end
            if vladce.ksichty == 0 and vladce.cinnost == 0 then
                if vladce.delay > 0 then
                    vladce.delay = vladce.delay - 1
                elseif no_dialog() then
                    if vladce.vital == 0 then
                        vladce.cinnost = 1
                        vladce.vital = 1
                    elseif vladce.obecne == 0 or random(100) < 60 then
                        pom1 = random(5)
                        if (vladce.obecne and bitpole[pom1]) == 0 then
                            vladce.obecne = vladce.obecne or bitpole[pom1]
                            vladce.cinnost = 2 + pom1
                            vladce.promluvila = vladce.promluvila + 1
                        end
                    else
                        pom1 = random(5)
                        if (vladce.specialni and bitpole[pom1]) == 0 then
                            vladce.specialni = vladce.specialni or bitpole[pom1]
                            vladce.cinnost = 7 + pom1
                            vladce.promluvila = vladce.promluvila + 1
                        end
                    end
                end
            end
            if vladce.ksichty == 0 then
                switch(vladce.cinnost){
                    [0] = function()
                        if random(50) == 0 then
                            vladce.faze = 0
                            switch(vladce.afaze){
                                [1] = function()
                                    switch(random(5)){
                                        [0] = function()
                                            vladce.ksichty = 20
                                        end,
                                        [1] = function()
                                            vladce.ksichty = 10
                                        end,
                                        [2] = function()
                                            vladce.ksichty = 12
                                        end,
                                        [3] = function()
                                            vladce.afaze = 2
                                        end,
                                        [4] = function()
                                            vladce.ksichty = 21
                                        end,
                                    }
                                end,
                                [10] = function()
                                    switch(random(2)){
                                        [0] = function()
                                            vladce.ksichty = 11
                                        end,
                                        [1] = function()
                                            vladce.ksichty = 14
                                        end,
                                    }
                                end,
                                [11] = function()
                                    switch(random(2)){
                                        [0] = function()
                                            vladce.ksichty = 13
                                        end,
                                        [1] = function()
                                            vladce.ksichty = 22
                                        end,
                                    }
                                end,
                                [14] = function()
                                    switch(random(3)){
                                        [0, 1] = function()
                                            vladce.ksichty = 1
                                        end,
                                        [2] = function()
                                            vladce.afaze = 1
                                            vladce.cinnost = 10
                                            vladce.faze = vladce.faze - 1
                                        end,
                                    }
                                end,
                                [6] = function()
                                    switch(random(3)){
                                        [0] = function()
                                            vladce.ksichty = 12
                                        end,
                                        [1] = function()
                                            vladce.afaze = 1
                                        end,
                                    }
                                end,
                                default = function()
                                    vladce.afaze = 1
                                end,
                            }
                        end
                    end,
                    [1] = function()
                        vladce.delay = -1
                        talk("vit-hs-vitejte" + chr(ord("A") + random(4)), 302)
                        vladce.ksichty = 2
                        vladce.cinnost = 0
                    end,
                    [2] = function()
                        vladce.delay = -1
                        talk("vit-hs-demoni0", 302)
                        vladce.ksichty = 1
                        vladce.cinnost = 0
                    end,
                    [3] = function()
                        vladce.delay = -1
                        talk("vit-hs-dite0", 302)
                        vladce.ksichty = 3
                        vladce.cinnost = 0
                    end,
                    [4] = function()
                        vladce.delay = -1
                        talk("vit-hs-lod0", 302)
                        vladce.ksichty = 1
                        vladce.cinnost = 0
                    end,
                    [5] = function()
                        vladce.delay = -1
                        talk("vit-hs-soud0", 302)
                        vladce.ksichty = 4
                        vladce.cinnost = 0
                    end,
                    [6] = function()
                        talk("vit-hs-jidelna1", 302)
                        vladce.ksichty = 1
                        vladce.cinnost = 61
                    end,
                    [61] = function()
                        addm(0, "vit-m-jakze")
                        addv(0, "vit-v-vazne")
                        addm(0, "vit-m-nechutne")
                        addset(vladce.cinnost, 63)
                        vladce.cinnost = 62
                    end,
                    [63] = function()
                        talk("vit-hs-jidelna2", 302)
                        vladce.ksichty = 4
                        vladce.cinnost = 0
                        vladce.delay = -1
                    end,
                    [7] = function()
                        vladce.delay = -1
                        talk("vit-hs-kacir", 302)
                        vladce.ksichty = 4
                        vladce.cinnost = 0
                    end,
                    [8] = function()
                        vladce.delay = -1
                        talk("vit-hs-vodovod0", 302)
                        vladce.ksichty = 2
                        vladce.cinnost = 0
                    end,
                    [9] = function()
                        talk("vit-x-beg", 303)
                        vladce.ksichty = 10
                        vladce.faze = 0
                        vladce.cinnost = 91
                    end,
                    [91] = function()
                        if not playing(303) then
                            vladce.cinnost = vladce.cinnost + 1
                            vladce.ksichty = 3
                            talk("vit-hs-reklama1", 302)
                        end
                    end,
                    [92] = function()
                        vladce.cinnost = vladce.cinnost + 1
                        vladce.ksichty = 4
                        talk("vit-hs-reklama2", 302)
                    end,
                    [93] = function()
                        vladce.cinnost = vladce.cinnost + 1
                        vladce.ksichty = 3
                        talk("vit-hs-reklama3", 302)
                    end,
                    [94] = function()
                        vladce.cinnost = vladce.cinnost + 1
                        vladce.ksichty = 4
                        talk("vit-hs-reklama4", 302)
                    end,
                    [95] = function()
                        vladce.cinnost = vladce.cinnost + 1
                        vladce.ksichty = 2
                        talk("vit-hs-reklama5", 302)
                    end,
                    [96] = function()
                        vladce.cinnost = 0
                        vladce.delay = -1
                        vladce.ksichty = 10
                        vladce.faze = 0
                        talk("vit-x-end", 303)
                    end,
                    [10] = function()
                        vladce.cinnost = 101
                        vladce.ksichty = 2
                        talk("vit-hs-klid1", 302)
                    end,
                    [101] = function()
                        vladce.cinnost = vladce.cinnost + 1
                        vladce.ksichty = 4
                        talk("vit-hs-klid2", 302)
                    end,
                    [102] = function()
                        vladce.cinnost = vladce.cinnost + 1
                        vladce.ksichty = 12
                        vladce.faze = 0
                        vladce.delay = 5
                    end,
                    [103] = function()
                        if vladce.delay > 0 then
                            vladce.delay = vladce.delay - 1
                        else
                            vladce.cinnost = vladce.cinnost + 1
                            vladce.ksichty = 13
                            vladce.faze = 0
                        end
                    end,
                    [104] = function()
                        vladce.cinnost = vladce.cinnost + 1
                        vladce.ksichty = 3
                        talk("vit-hs-klid3", 302)
                    end,
                    [105] = function()
                        vladce.cinnost = vladce.cinnost + 1
                        vladce.ksichty = 2
                        talk("vit-hs-klid4", 302)
                    end,
                    [106] = function()
                        vladce.cinnost = vladce.cinnost + 1
                        vladce.ksichty = 12
                        vladce.faze = 0
                        vladce.delay = 3
                    end,
                    [107, 108] = function()
                        if vladce.delay > 0 then
                            vladce.delay = vladce.delay - 1
                        else
                            vladce.cinnost = vladce.cinnost + 1
                            vladce.ksichty = 22
                            vladce.faze = 0
                            vladce.delay = 1
                        end
                    end,
                    [109] = function()
                        vladce.delay = -1
                        vladce.cinnost = 0
                    end,
                    [11] = function()
                        vladce.delay = -1
                        talk("vit-hs-pojis0", 302)
                        vladce.ksichty = 2
                        vladce.cinnost = 0
                    end,
                    default = function()
                        vladce.cinnost = 0
                    end,
                }
            end
            switch(vladce.ksichty){
                [0] = function()
                end,
                [1, 2, 3, 4] = function()
                    if math.mod(count, 2) == 0 then
                        if Playing(302) then
                            pom1 = random(3)
                        else
                            pom1 = 3
                        end
                        switch(vladce.ksichty){
                            [1] = function()
                                switch(pom1){
                                    [0, 3] = function()
                                        vladce.afaze = 1
                                    end,
                                    [1] = function()
                                        vladce.afaze = 15
                                    end,
                                    [2] = function()
                                        vladce.afaze = 18
                                    end,
                                }
                            end,
                            [2] = function()
                                switch(pom1){
                                    [0] = function()
                                        vladce.afaze = 4
                                    end,
                                    [1] = function()
                                        vladce.afaze = 16
                                    end,
                                    [2] = function()
                                        vladce.afaze = 20
                                    end,
                                    [3] = function()
                                        vladce.afaze = 1
                                    end,
                                }
                            end,
                            [3] = function()
                                switch(pom1){
                                    [0, 3] = function()
                                        vladce.afaze = 14
                                    end,
                                    [1] = function()
                                        vladce.afaze = 17
                                    end,
                                    [2] = function()
                                        vladce.afaze = 19
                                    end,
                                }
                            end,
                            [4] = function()
                                switch(pom1){
                                    [0] = function()
                                        vladce.afaze = 6
                                    end,
                                    [1] = function()
                                        vladce.afaze = 15
                                    end,
                                    [2] = function()
                                        vladce.afaze = 18
                                    end,
                                    [3] = function()
                                        vladce.afaze = 11
                                    end,
                                }
                            end,
                        }
                        if pom1 == 3 then
                            vladce.ksichty = 0
                        end
                    end
                end,
                [10] = function()
                    vladce.faze = vladce.faze + 1
                    switch(vladce.faze){
                        [1] = function()
                            vladce.afaze = 5
                        end,
                        [2] = function()
                            vladce.afaze = 9
                        end,
                        [3] = function()
                            vladce.afaze = 10
                        end,
                        [4] = function()
                            vladce.ksichty = 0
                        end,
                    }
                end,
                [11] = function()
                    vladce.faze = vladce.faze + 1
                    switch(vladce.faze){
                        [1] = function()
                            vladce.afaze = 9
                        end,
                        [2] = function()
                            vladce.afaze = 5
                        end,
                        [3] = function()
                            vladce.afaze = 1
                        end,
                        [4] = function()
                            vladce.ksichty = 0
                        end,
                    }
                end,
                [12] = function()
                    vladce.faze = vladce.faze + 1
                    switch(vladce.faze){
                        [1] = function()
                            vladce.afaze = 6
                        end,
                        [2] = function()
                            vladce.afaze = 7
                        end,
                        [3] = function()
                            vladce.afaze = 11
                        end,
                        [4] = function()
                            vladce.ksichty = 0
                        end,
                    }
                end,
                [13] = function()
                    vladce.faze = vladce.faze + 1
                    switch(vladce.faze){
                        [1] = function()
                            vladce.afaze = 7
                        end,
                        [2] = function()
                            vladce.afaze = 6
                        end,
                        [3] = function()
                            vladce.afaze = 1
                        end,
                        [4] = function()
                            vladce.ksichty = 0
                        end,
                    }
                end,
                [14] = function()
                    vladce.faze = vladce.faze + 1
                    switch(vladce.faze){
                        [1] = function()
                            vladce.afaze = 9
                        end,
                        [2] = function()
                            vladce.afaze = 5
                        end,
                        [3] = function()
                            vladce.afaze = 14
                        end,
                        [4] = function()
                            vladce.ksichty = 0
                        end,
                    }
                end,
                [20] = function()
                    vladce.faze = vladce.faze + 1
                    switch(vladce.faze){
                        [1] = function()
                            vladce.afaze = 6
                        end,
                        [2.. --FIXME: range
3] = function()
                            vladce.afaze = 8
                        end,
                        [4] = function()
                            vladce.afaze = 6
                        end,
                        [5] = function()
                            vladce.ksichty = 0
                        end,
                    }
                end,
                [21] = function()
                    vladce.faze = vladce.faze + 1
                    switch(vladce.faze){
                        [1, 3, 5] = function()
                            vladce.afaze = 1
                        end,
                        [2] = function()
                            vladce.afaze = 4
                        end,
                        [6] = function()
                            vladce.ksichty = 0
                        end,
                    }
                end,
                [22] = function()
                    vladce.faze = vladce.faze + 1
                    switch(vladce.faze){
                        [1, 3, 5] = function()
                            vladce.afaze = 11
                        end,
                        [2] = function()
                            vladce.afaze = 12
                        end,
                        [6] = function()
                            vladce.ksichty = 0
                        end,
                    }
                end,
            }
            vladce.afaze = vladce.afaze - 1
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_krabi()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        for pom1 = 0, 6 do
            globpole[pom1] = 0
            krabi.afaze = 1
        end

        return function()
            pomb1 = talking(302) or talking(303)
            for pom1 = 0, 6 do
                pom2 = dist(@ --FIXME: addr
vladce, this + pom1)
                if (--FIXME: pointer
Items[this + pom1]^).dir IN --FIXME: IN
{dir_left, dir_right} then
                    if globpole[pom1] < 3 then
                        globpole[pom1] = 3
                    end
                    globpole[pom1] = math.mod(globpole[pom1] - 2, 4) + 3
                    switch(globpole[pom1]){
                        [3, 5] = function()
                            (--FIXME: pointer
Items[this + pom1]^).afaze = 0
                        end,
                        [4] = function()
                            (--FIXME: pointer
Items[this + pom1]^).afaze = 6
                        end,
                        [6] = function()
                            (--FIXME: pointer
Items[this + pom1]^).afaze = 8
                        end,
                    }
                elseif pom2 <= 4 and pomb1 then
                    globpole[pom1] = 1
                    (--FIXME: pointer
Items[this + pom1]^).afaze = random(5) + 1
                    if (--FIXME: pointer
Items[this + pom1]^).afaze == 1 then
                        (--FIXME: pointer
Items[this + pom1]^).afaze = 0
                    end
                elseif pom2 <= 10 and pomb1 then
                    globpole[pom1] = 2
                    if (--FIXME: pointer
Items[this + pom1]^).afaze == 1 or random(100) < 10 then
                        (--FIXME: pointer
Items[this + pom1]^).afaze = random(5) + 1
                        if (--FIXME: pointer
Items[this + pom1]^).afaze == 1 then
                            (--FIXME: pointer
Items[this + pom1]^).afaze = 0
                        end
                    end
                    if random(100) < 5 then
                        (--FIXME: pointer
Items[this + pom1]^).afaze = 1
                    end
                else
                    switch(globpole[pom1]){
                        [0] = function()
                            (--FIXME: pointer
Items[this + pom1]^).afaze = 1
                        end,
                        [1] = function()
                            globpole[pom1] = -random(20) - 20
                        end,
                        [2] = function()
                            globpole[pom1] = -random(20) - 5
                        end,
                        [3.. --FIXME: range
6] = function()
                            globpole[pom1] = -random(10) - 4
                            (--FIXME: pointer
Items[this + pom1]^).afaze = 0
                        end,
                        default = function()
                            if random(-globpole[pom1]) < 4 then
                                (--FIXME: pointer
Items[this + pom1]^).afaze = 1
                            elseif random(100) < globpole[pom1] or (--FIXME: pointer
Items[this + pom1]^).afaze == 1 then
                                (--FIXME: pointer
Items[this + pom1]^).afaze = random(5) + 1
                                if (--FIXME: pointer
Items[this + pom1]^).afaze == 1 then
                                    (--FIXME: pointer
Items[this + pom1]^).afaze = 0
                                end
                            end
                            globpole[pom1] = globpole[pom1] + 1
                        end,
                    }
                end
            end
        end
    end

    -- --------------------
    local update_table = {}
    local subinit
    subinit = prog_init_room()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_vladce()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_krabi()
    if subinit then
        table.insert(update_table, subinit)
    end
    return update_table
end
local update_table = prog_init()


-- -----------------------------------------------------------------
-- Update
-- -----------------------------------------------------------------
function prog_update()
    for key, subupdate in pairs(update_table) do
        subupdate()
    end
end

