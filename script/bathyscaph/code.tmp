
-- -----------------------------------------------------------------
-- Init
-- -----------------------------------------------------------------
local function prog_init()
    initModels()
    sound_playMusic("music/rybky07.ogg")
    local pokus = getRestartCount()


    -- -------------------------------------------------------------
    local function prog_init_room()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        room.aktivni = (@ --FIXME: addr
main)
        room.poc = random(50 + pokus) + 100
        room.halo = 0
        room.mikros = 0
        room.nemam = 200
        room.odsud = 0
        room.pronej = 10 + random(50)
        room.uhnu = 500 + random(500)
        room.teduz = 0

        return function()
            switch(room.aktivni){
                [@ --FIXME: addr
main] = function()
                    if room.poc > 0 then
                        room.poc = room.poc - 1
                    else
                        pomb1 = zluty.x == ztel.x and zluty.y + 3 == ztel.y
                        pomb2 = modry.x == mtel.x and modry.y + 3 == mtel.y
                        room.poc = random(80) + 50
                        room.zvon = 0
                        if pomb1 then
                            if pomb2 then
                                if odd(random(10)) then
                                    room.aktivni = (@ --FIXME: addr
zluty)
                                else
                                    room.aktivni = (@ --FIXME: addr
modry)
                                end
                            else
                                room.aktivni = (@ --FIXME: addr
zluty)
                            end
                        elseif pomb2 then
                            room.aktivni = (@ --FIXME: addr
modry)
                        else
                            room.aktivni = (@ --FIXME: addr
ibudik)
                        end
                    end
                end,
                [@ --FIXME: addr
zluty] = function()
                    if room.poc == 0 then
                        ksnd(51)
                        room.poc = random(30) + 30
                        room.aktivni = (@ --FIXME: addr
main)
                        zluty.afaze = 0
                    else
                        room.poc = room.poc - 1
                        if room.pronej > 0 then
                            room.pronej = room.pronej - 1
                        end
                        if zluty.x == ztel.x and zluty.y + 3 == ztel.y then
                            if playing(51) then
                                room.zvon = room.zvon + 1
                                if odd(room.zvon) then
                                    zluty.afaze = 1
                                else
                                    zluty.afaze = 2
                                end
                            elseif room.zvon > 0 then
                                room.zvon = room.zvon - 1
                                zluty.afaze = 0
                            else
                                snd("bat-t-phone0", 51)
                            end
                        else
                            ksnd(51)
                            zluty.afaze = 0
                            room.aktivni = (@ --FIXME: addr
ztel)
                            room.halo = 1
                        end
                    end
                end,
                [@ --FIXME: addr
modry] = function()
                    if room.poc == 0 then
                        ksnd(52)
                        room.poc = random(30) + 30
                        room.aktivni = (@ --FIXME: addr
main)
                        modry.afaze = 0
                    else
                        room.poc = room.poc - 1
                        if room.pronej > 0 then
                            room.pronej = room.pronej - 1
                        end
                        if modry.x == mtel.x and modry.y + 3 == mtel.y then
                            if playing(52) then
                                room.zvon = room.zvon + 1
                                if odd(room.zvon) then
                                    modry.afaze = 1
                                else
                                    modry.afaze = 2
                                end
                            elseif room.zvon > 0 then
                                room.zvon = room.zvon - 1
                                modry.afaze = 0
                            else
                                snd("bat-t-phone1", 52)
                            end
                        else
                            ksnd(52)
                            modry.afaze = 0
                            room.aktivni = (@ --FIXME: addr
mtel)
                            room.halo = 1
                        end
                    end
                end,
                [@ --FIXME: addr
ztel, @ --FIXME: addr
mtel] = function()
                    if room.halo ~= 2 then
                        room.aktivni = (@ --FIXME: addr
main)
                        room.poc = random(100) + 30
                    end
                end,
                [@ --FIXME: addr
ibudik] = function()
                    if room.poc > 0 then
                        room.poc = room.poc - 1
                    elseif not playing(50) then
                        sndcyc("bat-t-budik", 50)
                    elseif ibudik.dir ~= dir_no then
                        ksnd(50)
                        room.aktivni = -1
                    end
                end,
            }
            if room.halo == 1 then
                room.halo = 2
                if pokus > 5 then
                    pom1 = random(11)
                else
                    pom1 = random(8)
                end
                switch(pom1){
                    [0] = function()
                        pom2 = 1 + 2
                    end,
                    [1] = function()
                        pom2 = 1 + 4 + 16
                    end,
                    [2] = function()
                        pom2 = 1 + 8
                    end,
                    [3] = function()
                        pom2 = 32
                    end,
                    [4] = function()
                        pom2 = 32 + 16
                    end,
                    [5] = function()
                        pom2 = 1 + 4
                    end,
                    [6] = function()
                        pom2 = 1 + 8 + 16
                    end,
                    [7] = function()
                        pom2 = 2
                    end,
                    default = function()
                        pom2 = 0
                    end,
                }
                if (pom2 and 1) > 0 then
                    addd(5, "bat-p-0", 49, noprom)
                end
                if (pom2 and 2) > 0 then
                    addd(5, "bat-p-1", 49, noprom)
                end
                if (pom2 and 4) > 0 then
                    addd(5, "bat-p-2", 49, noprom)
                end
                if (pom2 and 8) > 0 then
                    addd(5, "bat-p-3", 49, noprom)
                end
                if (pom2 and 32) > 0 then
                    addd(5, "bat-p-5", 49, noprom)
                end
                if (pom2 and 16) > 0 then
                    addd(5, "bat-p-4", 49, noprom)
                end
                if pom2 == 0 then
                    addd(5, "bat-p-zhov" + chr(48 + random(2)), 49, noprom)
                end
                addset(room.halo, 0)
            end
            if no_dialog() and isReady(small) and isReady(big) then
                if count == 20 and random(pokus) < 3 then
                    addm(5, "bat-m-tohle")
                elseif room.mikros == 0 and dist(@ --FIXME: addr
small, @ --FIXME: addr
mikroskop) < 3 and mikroskop.dir ~= dir_no and random(10) == 1 then
                    room.mikros = 1
                    addm(6, "bat-m-mikro")
                elseif room.odsud == 0 and zluty.x > 32 and dist(@ --FIXME: addr
small, @ --FIXME: addr
zluty) < 4 and random(30) == 1 then
                    room.odsud = 1
                    addm(7, "bat-m-sluch")
                elseif room.teduz == 0 and room.aktivni == -1 and random(70) == 1 then
                    room.teduz = 1
                    addv(8, "bat-v-klid")
                elseif room.nemam > 0 then
                    room.nemam = room.nemam - 1
                else
                    switch(room.aktivni){
                        [@ --FIXME: addr
ibudik] = function()
                            if random(100) == 1 then
                                room.nemam = 200 + random(200)
                                addv(1, "bat-v-vyp")
                            end
                        end,
                        [@ --FIXME: addr
zluty, @ --FIXME: addr
modry] = function()
                            if random(100) == 1 then
                                room.nemam = 200 + random(200)
                                if dist(@ --FIXME: addr
small, room.aktivni) < dist(@ --FIXME: addr
big, room.aktivni) then
                                    addv(1, "bat-v-zved1")
                                else
                                    addv(1, "bat-v-zved0")
                                end
                            end
                        end,
                    }
                end
            end
            if no_dialog() then
                if room.pronej == 0 and (room.aktivni == (@ --FIXME: addr
zluty) or room.aktivni == (@ --FIXME: addr
modry)) and random(30) == 1 then
                    room.pronej = random(100)
                    addd(3, "bat-s-prome" + chr(48 + random(3)), 111, snek.mluvi)
                elseif room.uhnu == 0 and (room.aktivni == -1 or room.poc > 30 and room.aktivni == (@ --FIXME: addr
main)) then
                    room.uhnu = 300 + random(300)
                    pom2 = random(4)
                    if pom2 ~= 1 or roompole[1] > 0 then
                        addd(12, "bat-s-sn" + "ek" + chr(48 + pom2), 111, snek.mluvi)
                    end
                    roompole[1] = roompole[1] + 1
                end
            end
            if room.uhnu > 0 then
                room.uhnu = room.uhnu - 1
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_dhled()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        dhled.padal = 0

        return function()
            if dhled.padal == 4 then
                dhled.afaze = 0
                dhled.padal = 0
            elseif dhled.padal == 3 then
                dhled.padal = 4
            elseif dhled.padal == 2 then
                dhled.padal = 3
            elseif dhled.dir == dir_down then
                dhled.padal = 1
            elseif dhled.padal == 1 then
                dhled.afaze = 1
                dhled.padal = 2
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_snek()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        snek.mluvi = 0

        return function()
            if odd(count) and snek.mluvi ~= 0 then
                snek.afaze = random(2)
            else
                snek.afaze = 0
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_ibudik()
        return function()
            if odd(count) and playing(50) then
                ibudik.afaze = 1
            else
                ibudik.afaze = 0
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_mikroskop()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        mikroskop.poc = 0

        return function()
            if mikroskop.poc > 0 then
                mikroskop.poc = mikroskop.poc - 1
            else
                mikroskop.afaze = random(3)
                mikroskop.poc = random(6)
            end
            if mikroskop.dir ~= dir_no then
                mikroskop.poc = 0
            end
        end
    end

    -- --------------------
    local update_table = {}
    local subinit
    subinit = prog_init_room()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_dhled()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_snek()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_ibudik()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_mikroskop()
    if subinit then
        table.insert(update_table, subinit)
    end
    return update_table
end
local update_table = prog_init()


-- -----------------------------------------------------------------
-- Update
-- -----------------------------------------------------------------
function prog_update()
    for key, subupdate in pairs(update_table) do
        subupdate()
    end
end

