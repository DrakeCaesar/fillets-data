
-- -----------------------------------------------------------------
-- Init
-- -----------------------------------------------------------------
local function prog_init()
    initModels()
    sound_playMusic("music/rybky03.ogg")
    local pokus = getRestartCount()


    -- -------------------------------------------------------------
    local function prog_init_room()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        if pokus <= 1 then
            roompole[1] = 0
        else
            roompole[1] = roompole[1] + 1
        end
        room.uz = 30 + random(20)

        return function()
            if room.dir ~= dir_no then
                roompole[1] = 0
            end
            if count == room.uz and isReady(small) and isReady(big) then
                if roompole[1] > 4 then
                    roompole[1] = -1
                    addm(1, "zav-m-hrac")
                    addv(9, "zav-v-zachranit")
                    inc(room.uz, 222 + random(1111))
                else
                    if roompole[1] > 0 then
                        roompole[1] = roompole[1] - 1
                    end
                    pom1 = random(pokus + 1)
                    if pom1 > 4 or roompole[1] == -1 then
                        pom1 = random(3)
                    end
                    switch(pom1){
                        [0] = function()
                            addv(1, "zav-v-sto")
                            if random(3) > 0 then
                                addv(6, "zav-v-trpyt")
                            end
                            if big.Y == big.YStart then
                                addm(9, "zav-m-pohnout")
                            end
                        end,
                        [1] = function()
                            addm(1, "zav-m-krasa")
                            addv(9, "zav-v-venku")
                        end,
                        [2] = function()
                            addv(1, "zav-v-zaval")
                            addm(9, "zav-m-hopskok")
                        end,
                        [3] = function()
                            addm(1, "zav-m-kameny")
                            addv(9, "zav-v-zeleny")
                        end,
                        [4] = function()
                            addv(1, "zav-v-restart")
                            addm(8, "zav-m-pravda")
                        end,
                    }
                    inc(room.uz, 666 + random(2222))
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_drahokamy()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        for pom1 = 3, 111 do
            (--FIXME: pointer
Items[pom1]^).BMP = (--FIXME: pointer
Items[3]^).BMP
            globpole[pom1] = -random(100)
            (--FIXME: pointer
Items[pom1]^).afaze = random(6) * 4
        end

        return function()
            for pom1 = 3, 111 do
                globpole[pom1] = globpole[pom1] + 1
                switch(globpole[pom1]){
                    [1, 2, 3] = function()
                        (--FIXME: pointer
Items[pom1]^).afaze = (--FIXME: pointer
Items[pom1]^).afaze + 1
                    end,
                    [4, 5, 6] = function()
                        (--FIXME: pointer
Items[pom1]^).afaze = (--FIXME: pointer
Items[pom1]^).afaze - 1
                    end,
                    [7] = function()
                        globpole[pom1] = -random(100) - 10
                    end,
                }
            end
        end
    end

    -- --------------------
    local update_table = {}
    local subinit
    subinit = prog_init_room()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_drahokamy()
    if subinit then
        table.insert(update_table, subinit)
    end
    return update_table
end
local update_table = prog_init()


-- -----------------------------------------------------------------
-- Update
-- -----------------------------------------------------------------
function prog_update()
    for key, subupdate in pairs(update_table) do
        subupdate()
    end
end

