
-- -----------------------------------------------------------------
-- Init
-- -----------------------------------------------------------------
local function prog_init()
    initModels()
    sound_playMusic("music/rybky03.ogg")
    local pokus = getRestartCount()


    -- -------------------------------------------------------------
    local function prog_init_room()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        room.uvod = 0
        room.sas = 0
        room.kuk = 0
        room.okoralech = 0
        room.obarvach = 0
        room.neprojedes = 0
        room.mohlabys = 0

        return function()
            if isReady(small) and isReady(big) and no_dialog() then
                if room.uvod == 0 then
                    room.uvod = 1
                    switch(random(1)){
                        [0] = function()
                            addm(20 + random(30), "ncp-m-tesno0")
                        end,
                        [1] = function()
                            addm(20 + random(30), "ncp-m-tesno1")
                        end,
                    }
                    if random(100) < 30 then
                        addv(random(8), "ncp-v-dostala")
                    end
                elseif look_at(@ --FIXME: addr
small, @ --FIXME: addr
sasanka) and dist(@ --FIXME: addr
small, @ --FIXME: addr
sasanka) < 3 and room.sas == 0 and random(100) < 20 then
                    addv(random(5), "ncp-v-s" + "asanka")
                    room.sas = 1
                elseif look_at(@ --FIXME: addr
small, @ --FIXME: addr
konik) and konik.afaze == 3 and dist(@ --FIXME: addr
small, @ --FIXME: addr
konik) < 4 and room.kuk == 0 then
                    addm(random(5), "ncp-m-nekoukej")
                    room.kuk = 1
                elseif (koral1.dir ~= dir_no or koral2.dir ~= dir_no or koral3.dir ~= dir_no or koral0.dir ~= dir_no) and room.okoralech == 0 and random(100) < 2 then
                    room.okoralech = 1
                    if aktivni == velka then
                        addv(0, "ncp-v-mekky")
                    else
                        switch(random(5)){
                            [0.. --FIXME: range
3] = function()
                                addm(0, "ncp-m-tvrdy")
                            end,
                            [4] = function()
                                addm(0, "ncp-m-komari")
                                addv(random(3), "ncp-v-ceho")
                                addm(random(3), "ncp-m-koraly")
                            end,
                        }
                    end
                elseif big.x == 4 and big.y == 29 and aktivni == velka and room.neprojedes == 0 and random(100) < 10 then
                    addv(random(3), "ncp-v-neprojedu")
                    room.neprojedes = 1
                elseif room.obarvach == 0 and random(10000) < 5 then
                    room.obarvach = 1
                    addm(random(10), "ncp-m-barvy")
                elseif valec.x == 3 and valec.y == 34 and room.mohlabys == 0 then
                    room.mohlabys = 1
                    addv(random(3), "ncp-v-tak")
                    if random(100) < 80 then
                        addm(random(10), "ncp-m-muzes")
                    end
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_sasanka()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        sasanka.cinnost = 0
        sasanka.noha = 0
        sasanka.kvet = 1
        sasanka.akcnost = 1

        return function()
            if sasanka.cinnost ~= 5 and (dist(little, this) < 3 or dist(big, this) < 3) then
                sasanka.cinnost = 5
                sasanka.counts = random(10) + 15
                sasanka.akcnost = 1
            end
            if sasanka.cinnost == 0 then
                sasanka.cinnost = random(4) + 1
                sasanka.fazec = 0
                sasanka.akcnost = 2 + random(2)
            end
            if math.mod(count, sasanka.akcnost) == 0 then
                switch(sasanka.cinnost){
                    [1, 2] = function()
                        sasanka.noha = math.floor(sasanka.fazec / 4)
                        if sasanka.cinnost == 1 then
                            sasanka.kvet = math.mod(sasanka.fazec, 2) + 1
                            sasanka.akcnost = 2
                            if sasanka.kvet == 2 then
                                Snd("ncp-x-tup", 500)
                            end
                        else
                            sasanka.kvet = math.mod(sasanka.fazec, 2) * 2 + 1
                            sasanka.akcnost = 3
                        end
                        sasanka.fazec = sasanka.fazec + 1
                        if sasanka.fazec == 8 then
                            if random(100) < 30 then
                                sasanka.cinnost = 0
                            else
                                sasanka.fazec = 0
                            end
                        end
                    end,
                    [3, 4] = function()
                        switch(sasanka.fazec){
                            [0] = function()
                                sasanka.counts = random(10) + 7
                                sasanka.fazec = sasanka.fazec + 1
                                sasanka.kvet = 1
                            end,
                            [1] = function()
                                sasanka.noha = 1 - sasanka.noha
                                sasanka.counts = sasanka.counts - 1
                                if sasanka.counts == 0 then
                                    sasanka.fazec = sasanka.fazec + 1
                                end
                            end,
                            [2] = function()
                                if sasanka.cinnost == 3 then
                                    sasanka.kvet = 0
                                    sasanka.counts = random(8) + 5
                                else
                                    sasanka.kvet = 3
                                    sasanka.counts = random(6) + 3
                                end
                                sasanka.fazec = sasanka.fazec + 1
                            end,
                            [3] = function()
                                sasanka.counts = sasanka.counts - 1
                                if sasanka.counts == 0 then
                                    if random(100) < 30 then
                                        sasanka.cinnost = 0
                                    else
                                        sasanka.fazec = 0
                                    end
                                end
                            end,
                        }
                    end,
                    [5] = function()
                        sasanka.akcnost = 2
                        sasanka.counts = sasanka.counts - 1
                        switch(sasanka.counts){
                            [0] = function()
                                sasanka.cinnost = 0
                            end,
                            [1] = function()
                                sasanka.kvet = 1
                                sasanka.noha = 1 - sasanka.noha
                            end,
                            default = function()
                                sasanka.kvet = 0
                            end,
                        }
                    end,
                }
            end
            sasanka.afaze = sasanka.noha * 4 + sasanka.kvet
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_snek()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        snek.stav = 0

        return function()
            switch(snek.stav){
                [0] = function()
                    if snek.Dir ~= dir_no then
                        snek.stav = 1
                    end
                end,
                [1] = function()
                    snek.afaze = 3
                    snek.stav = snek.stav + 1
                end,
                [2] = function()
                    snek.afaze = 1
                    snek.stav = snek.stav + 1
                end,
                [3] = function()
                    snek.afaze = 2
                    if snek.dir == dir_no then
                        snek.stav = 4
                        snek.count = 20
                    end
                end,
                [4] = function()
                    snek.count = snek.count - 1
                    if snek.count == 0 then
                        snek.stav = 5
                        snek.count = 5
                    end
                    if snek.Dir ~= dir_no then
                        snek.stav = 2
                    end
                end,
                [5] = function()
                    snek.afaze = 1
                    snek.count = snek.count - 1
                    if snek.count == 0 then
                        snek.afaze = 0
                        snek.stav = 0
                    end
                    if snek.Dir ~= dir_no then
                        snek.stav = 1
                    end
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_small()
        return function()
            if delay[mala] >= 15 and delay[mala] < 40 and look_at(this, @ --FIXME: addr
konik) and ydist(this, @ --FIXME: addr
konik) == 0 and xdist(this, @ --FIXME: addr
konik) < 3 then
                if xicht[mala] ~= little_usmev then
                    xicht[mala] = little_usmev
                    konik.stav = 7
                end
            else
                xicht[mala] = 0
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_big()
        return function()
            if delay[velka] >= 15 and delay[velka] < 40 and look_at(this, @ --FIXME: addr
konik) and ydist(this, @ --FIXME: addr
konik) == 0 and xdist(this, @ --FIXME: addr
konik) < 3 then
                if xicht[velka] ~= 6 then
                    xicht[velka] = 6
                    konik.stav = 7
                end
            else
                xicht[velka] = 0
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_konik()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        konik.stav = 0
        konik.mrkani = 0

        return function()
            if konik.stav ~= 2 and konik.Dir == dir_down then
                Snd("ncp-x-ihaha", 300)
            end
            if konik.Dir == dir_down or elko.Dir == dir_down then
                konik.stav = 2
            elseif konik.stav == 2 then
                konik.stav = 0
            end
            switch(konik.stav){
                [0] = function()
                    pom1 = 15
                    if look_at(little, this) and abs(xdist(little, this)) <= 3 and abs(ydist(little, this)) <= 1 then
                        pom1 = 0
                    end
                    if look_at(big, this) and abs(xdist(big, this)) <= 3 and abs(ydist(big, this)) <= 1 then
                        pom1 = 0
                    end
                    if random(100) < pom1 then
                        konik.stav = 1
                        konik.mrkani = 0
                    end
                    konik.afaze = 0
                end,
                [1, 3, 4, 5] = function()
                    switch(konik.mrkani){
                        [0, 2] = function()
                            konik.afaze = 2
                        end,
                        [1] = function()
                            konik.afaze = 1
                            Snd("ncp-x-tik", 2000)
                        end,
                        [3] = function()
                            konik.afaze = 0
                            konik.mrkani = -1
                            if konik.stav == 1 then
                                konik.stav = 0
                            else
                                konik.stav = konik.stav + 1
                            end
                        end,
                    }
                    konik.mrkani = konik.mrkani + 1
                end,
                [2] = function()
                    konik.afaze = 3
                end,
                [6] = function()
                    konik.stav = 10
                    konik.mrkani = 10
                end,
                [7] = function()
                    konik.mrkani = 10
                    konik.stav = 8
                end,
                [8] = function()
                    konik.mrkani = konik.mrkani - 1
                    if konik.mrkani == 0 then
                        konik.stav = 3
                    end
                end,
                [10] = function()
                    if konik.mrkani > 0 then
                        konik.mrkani = konik.mrkani - 1
                    else
                        konik.stav = 11
                    end
                end,
                [11] = function()
                    konik.afaze = 3
                    konik.mrkani = random(10) + 10
                    konik.stav = konik.stav + 1
                end,
                [12] = function()
                    if konik.mrkani > 0 then
                        konik.mrkani = konik.mrkani - 1
                    else
                        konik.afaze = 0
                        konik.stav = 0
                    end
                end,
            }
        end
    end

    -- --------------------
    local update_table = {}
    local subinit
    subinit = prog_init_room()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_sasanka()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_snek()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_small()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_big()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_konik()
    if subinit then
        table.insert(update_table, subinit)
    end
    return update_table
end
local update_table = prog_init()


-- -----------------------------------------------------------------
-- Update
-- -----------------------------------------------------------------
function prog_update()
    for key, subupdate in pairs(update_table) do
        subupdate()
    end
end

