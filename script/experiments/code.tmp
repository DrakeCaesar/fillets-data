
-- -----------------------------------------------------------------
-- Init
-- -----------------------------------------------------------------
local function prog_init()
    initModels()
    sound_playMusic("music/rybky05.ogg")
    local pokus = getRestartCount()


    -- -------------------------------------------------------------
    local function prog_init_room()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        room.uvod = 0
        if pokus > 15 then
            room.uvod = random(2)
        end
        room.pokusy = 0
        room.bojidole = 0
        room.nerus = math.floor(pokus / 2)
        room.hnerus = 0
        if random(10) < pokus then
            room.zij = 1
        else
            room.zij = 0
        end
        room.kdy = random(1000 * pokus)
        room.kdy2 = random(2000 * pokus)
        if random(20) < pokus then
            room.pldicim = 1
        else
            room.pldicim = 0
        end
        room.pldiciv = 0
        room.kouk = 0
        room.fuja = -42
        room.ruk = 0
        room.zku = 0
        room.nep = 0
        room.vic = 0
        room.mrt = 0
        if math.mod(pokus, 3) > 0 then
            room.nedobre = 0
        else
            room.nedobre = 1
        end
        room.jej = 0
        room.kolem = 0

        return function()
            if no_dialog() and isReady(small) and isReady(big) then
                if room.uvod == 0 then
                    room.uvod = 1
                    addm(random(42) + 14, "bank-m-labolator" + chr(49 + random(3)))
                    if pokus > random(5) and random(4) == 1 then
                        room.pokusy = 1
                        addv(10, "bank-v-room.pokusy" + chr(49 + random(2)))
                    end
                end
                if room.bojidole == 0 and small.y > 26 and small.x < 20 then
                    room.bojidole = 1
                    addm(10, "bank-m-bojim")
                    if random(3) ~= 1 then
                        addm(10, "bank-m-ocicka")
                    end
                    if random(3) ~= 1 then
                        addv(15, "bank-v-pomoc")
                    end
                end
                if count == room.kdy2 then
                    if random(5) < 3 then
                        addm(20, "bank-m-prohlednout")
                        addv(22, "bank-v-vypad" + chr(49 + random(2)))
                    else
                        addm(20, "bank-m-tvorove")
                    end
                end
                if room.pldicim == 0 and small.x > 27 and small.y < 17 then
                    addm(8, "bank-m-nesetkala")
                    room.pldicim = 1
                end
                if room.pldiciv == 0 and big.x > 27 and big.y < 17 then
                    addv(25, "bank-v-mnozeni")
                    room.pldiciv = 1
                end
                if room.kouk == 0 and small.y > 26 and small.x + 1 <= oka.x then
                    room.kouk = 1
                    addm(2, "bank-m-kouka")
                end
                if room.fuja + 50 < count then
                    if lahvac.rozbit == 10 and dist(@ --FIXME: addr
small, @ --FIXME: addr
lahvac) < 4 or oka.dir ~= dir_no and dist(@ --FIXME: addr
small, @ --FIXME: addr
oka) < 4 then
                        addm(5, "bank-m-fuj")
                        room.fuja = count
                    end
                end
                if room.ruk == 0 and ruka.cinnost == 2 then
                    room.ruk = 1
                    addm(12, "bank-m-nervozni")
                end
                if room.zku == 0 then
                    pom2 = 0
                    for pom1 = 0, 15 do
                        if dist(@ --FIXME: addr
small, (@ --FIXME: addr
zkum) + pom1) < 2 then
                            pom2 = 1
                        end
                    end
                    if pom2 == 1 then
                        room.zku = 1
                        addm(7, "bank-m-zkumavka")
                    end
                end
                if room.kolem == 0 and no_dialog() and room.kouk + room.zku + room.ruk + room.pldicim + room.pldiciv + room.bojidole + room.jej + room.zij + room.uvod + room.pokusy + room.nep + room.mrt + room.nedobre > 7 then
                    room.kolem = 1
                    addm(42, "bank-m-hlavakolem")
                end
                if room.nep == 0 and big.x == 40 and big.y > 13 then
                    room.nep = 1
                    addv(4, "bank-v-neproplavu" + chr(49 + random(2)))
                end
                if room.vic < 2 and math.mod(count, 8) == 1 then
                    pom2 = 0
                    for pom1 = 1, itemcount - 1 do
                        --FIXME: WITH
                        with --FIXME: pointer
Items[pom1]^ do
                            if room.y < 21 and room.y > 17 and x > 14 and x < 29 then
                                pom2 = pom2 + 1
                            end
                        end
                    end
                    if room.vic == 0 and pom2 == 5 then
                        addv(5, "bank-v-nahazet")
                        room.vic = room.vic + 1
                    end
                    if room.vic == 1 and pom2 == 7 then
                        addv(5, "bank-v-jeste")
                        room.vic = room.vic + 1
                    end
                end
                if room.mrt == 0 and dist(@ --FIXME: addr
small, @ --FIXME: addr
kostra) < 3 then
                    room.mrt = 1
                    if random(3) ~= 1 then
                        addm(1, "bank-m-mrtvolka")
                    end
                    switch(random(5)){
                        [1, 2] = function()
                            addm(9, "bank-m-prehnal1")
                        end,
                        [3, 4] = function()
                            addm(9, "bank-m-prehnal2")
                        end,
                    }
                end
                if room.nedobre == 0 and lahvac.dir ~= dir_no then
                    room.nedobre = 1
                    addv(10, "bank-v-flaska")
                end
                if lahvac.afaze == 25 then
                    if random(2) == 1 then
                        addm(5, "bank-m-rozbila")
                    end
                end
                if room.jej == 0 and (dolni1.zije == -4 and dist(@ --FIXME: addr
dolni1, @ --FIXME: addr
small) < 11 or dolni2.zije == -4 and dist(@ --FIXME: addr
dolni2, @ --FIXME: addr
small) < 11) then
                    room.jej = 1
                    addm(5, "bank-m-jejda")
                end
                if room.pokusy == 0 and (big.x > 32 or big.y > 17) then
                    room.pokusy = 1
                    if random(3) ~= 1 then
                        addv(10, "bank-v-p" + "okusy" + chr(49 + random(2)))
                        room.hnerus = 1
                    end
                end
                if room.zij == 0 and count > math.floor((10000 - room.kdy - room.kdy2) / 16) then
                    room.zij = 1
                    addv(random(50), "bank-v-zije")
                    room.hnerus = 1
                end
                if count == room.kdy then
                    if random(3) == 1 then
                        addv(20, "bank-v-potvory")
                        if random(3) == 1 then
                            room.hnerus = 1
                        end
                    else
                        addm(20, "bank-m-organismy")
                    end
                end
            end
            if room.hnerus == 1 then
                if random(5) + room.nerus < 4 then
                    room.nerus = room.nerus + 1
                    addm(10, "bank-m-n" + "erus")
                end
            end
            room.hnerus = 0
            if count > room.kdy then
                inc(room.kdy, 1000 + random(10000))
            end
            if count > room.kdy2 then
                inc(room.kdy2, 1000 + random(10000))
            end
            if math.mod(count, 800) == 777 then
                switch(random(10)){
                    [1] = function()
                        room.ruk = 0
                    end,
                    [2] = function()
                        room.kouk = 0
                    end,
                    [3] = function()
                        room.mrt = 0
                    end,
                    [4] = function()
                        room.nedobre = 0
                    end,
                    [5] = function()
                        room.jej = 0
                    end,
                    [6] = function()
                        room.kolem = 0
                    end,
                    [7] = function()
                        room.nerus = 0
                    end,
                    [8] = function()
                        room.pokusy = 0
                    end,
                    [9] = function()
                        room.zij = 0
                    end,
                    [0] = function()
                        room.bojidole = 0
                    end,
                }
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_klicka()
        return function()
            klicka.afaze = math.mod(count, 2)
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_zataras()
        return function()
            if zataras.dir ~= dir_no then
                room.nep = 1
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_horni1()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        horni1.oci = 0

        return function()
            horni1.poloha = 0
            if dolni1.zije > 0 then
                if xdist(this, @ --FIXME: addr
dolni1) == 0 then
                    horni1.poloha = 3
                elseif horni1.y == dolni1.y then
                    switch(xdist(this, @ --FIXME: addr
dolni1)){
                        [1.. --FIXME: range
3] = function()
                            horni1.poloha = 1
                        end,
                        [-3.. --FIXME: range
-1] = function()
                            horni1.poloha = 2
                        end,
                    }
                end
            end
            if math.mod(count, 3) == 0 and random(100) < 40 then
                horni1.oci = random(5)
            end
            if random(100) < 2 then
                horni1.afaze = 5
            elseif horni1.poloha > 0 then
                horni1.afaze = horni1.poloha
            else
                horni1.afaze = horni1.oci
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_dolni1()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        dolni1.oci = 0
        dolni1.zije = -99

        return function()
            if horni1.x ~= x and dolni1.zije == -99 then
                dolni1.zije = -7
            end
            if dolni1.zije == -99 then
            elseif dolni1.zije <= 0 then
                dolni1.zije = dolni1.zije + 1
                dolni1.afaze = 1
            else
                if math.mod(count, 3) == 0 and random(100) < 40 then
                    dolni1.oci = random(4) + 2
                end
                pom1 = horni1.poloha
                if random(100) < 2 then
                    dolni1.afaze = 1
                elseif pom1 > 0 then
                    if pom1 == 3 then
                        dolni1.afaze = 3
                    else
                        dolni1.afaze = 3 + pom1
                    end
                else
                    dolni1.afaze = dolni1.oci
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_zkum()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        for pom1 = 0, 15 do
            globpole[pom1] = random(100) + 10
            (--FIXME: pointer
Items[(@ --FIXME: addr
zkum) + pom1]^).afaze = 0
            if random(2) == 0 then
                globpole[pom1] = -globpole[pom1]
            end
        end

        return function()
            for pom1 = 0, 15 do
                if globpole[pom1] > 0 then
                    globpole[pom1] = globpole[pom1] - 1
                    if globpole[pom1] == 0 then
                        globpole[pom1] = -random(100) - 10
                    end
                    if odd(count + pom1) then
                        if random(2) > 0 then
                            (--FIXME: pointer
Items[(@ --FIXME: addr
zkum) + pom1]^).afaze = math.mod((--FIXME: pointer
Items[(@ --FIXME: addr
zkum) + pom1]^).afaze + 1, 3)
                        else
                            (--FIXME: pointer
Items[(@ --FIXME: addr
zkum) + pom1]^).afaze = math.mod((--FIXME: pointer
Items[(@ --FIXME: addr
zkum) + pom1]^).afaze + 2, 3)
                        end
                    end
                else
                    globpole[pom1] = globpole[pom1] + 1
                    if globpole[pom1] == 0 then
                        globpole[pom1] = random(100) + 10
                    end
                    (--FIXME: pointer
Items[(@ --FIXME: addr
zkum) + pom1]^).afaze = 0
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_horni2()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        horni2.oci = 0

        return function()
            horni2.poloha = 0
            if dolni2.zije > 0 then
                if xdist(this, @ --FIXME: addr
dolni2) == 0 then
                    horni2.poloha = 3
                elseif horni2.y == dolni2.y then
                    switch(xdist(this, @ --FIXME: addr
dolni2)){
                        [1.. --FIXME: range
3] = function()
                            horni2.poloha = 1
                        end,
                        [-3.. --FIXME: range
-1] = function()
                            horni2.poloha = 2
                        end,
                    }
                end
            end
            if math.mod(count, 3) == 0 and random(100) < 40 then
                horni2.oci = random(5)
            end
            if random(100) < 2 then
                horni2.afaze = 5
            elseif horni2.poloha > 0 then
                horni2.afaze = horni2.poloha
            else
                horni2.afaze = horni2.oci
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_dolni2()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        dolni2.oci = 0
        dolni2.zije = -99

        return function()
            if horni2.x ~= x and dolni2.zije == -99 then
                dolni2.zije = -7
            end
            if dolni2.zije == -99 then
            elseif dolni2.zije <= 0 then
                dolni2.zije = dolni2.zije + 1
                dolni2.afaze = 1
            else
                if math.mod(count, 3) == 0 and random(100) < 40 then
                    dolni2.oci = random(4) + 2
                end
                pom1 = horni2.poloha
                if random(100) < 2 then
                    dolni2.afaze = 1
                elseif pom1 > 0 then
                    if pom1 == 3 then
                        dolni2.afaze = 3
                    else
                        dolni2.afaze = 3 + pom1
                    end
                else
                    dolni2.afaze = dolni2.oci
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_kostra()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        kostra.citac = random(200) + 200

        return function()
            if kostra.afaze < 8 then
                if kostra.citac == 0 then
                    kostra.afaze = kostra.afaze + 1
                    kostra.citac = random(200) + 200
                else
                    kostra.citac = kostra.citac - 1
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_oko()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        oko.cinnost = 0

        return function()
            switch(oko.cinnost){
                [0] = function()
                    if random(100) < 10 then
                        switch(random(8)){
                            [0.. --FIXME: range
2] = function()
                                oko.citac = random(5) + 5
                                oko.cinnost = 1
                                oko.faze = random(2) * 2
                            end,
                            [3] = function()
                                oko.citac = random(3) + 2
                                oko.cinnost = 2
                                oko.faze = random(2) * 2
                            end,
                            [4.. --FIXME: range
6] = function()
                                oko.citac = random(12) + 12
                                oko.cinnost = 3 + random(2)
                            end,
                            [7] = function()
                                oko.citac = random(10) + 2
                                oko.cinnost = 5
                            end,
                        }
                    end
                end,
                [1, 2] = function()
                    switch(oko.faze){
                        [0] = function()
                            if oko.cinnost == 1 then
                                oko.afaze = 1
                            else
                                oko.afaze = 3
                            end
                            if random(100) < 20 then
                                oko.faze = oko.faze + 1
                            end
                        end,
                        [1] = function()
                            oko.afaze = 0
                            oko.faze = oko.faze + 1
                        end,
                        [2] = function()
                            if oko.cinnost == 1 then
                                oko.afaze = 2
                            else
                                oko.afaze = 4
                            end
                            if random(100) < 20 then
                                oko.faze = oko.faze + 1
                            end
                        end,
                        [3] = function()
                            oko.afaze = 0
                            oko.citac = oko.citac - 1
                            if oko.citac == 0 then
                                oko.cinnost = 0
                            else
                                oko.faze = 0
                            end
                        end,
                    }
                end,
                [3, 4, 5] = function()
                    switch(oko.cinnost){
                        [3] = function()
                            switch(oko.afaze){
                                [0] = function()
                                    oko.afaze = random(4) + 1
                                end,
                                [1] = function()
                                    oko.afaze = 3
                                end,
                                [2] = function()
                                    oko.afaze = 4
                                end,
                                [3] = function()
                                    oko.afaze = 2
                                end,
                                [4] = function()
                                    oko.afaze = 1
                                end,
                            }
                        end,
                        [4] = function()
                            switch(oko.afaze){
                                [0] = function()
                                    oko.afaze = random(4) + 1
                                end,
                                [1] = function()
                                    oko.afaze = 4
                                end,
                                [2] = function()
                                    oko.afaze = 3
                                end,
                                [3] = function()
                                    oko.afaze = 1
                                end,
                                [4] = function()
                                    oko.afaze = 2
                                end,
                            }
                        end,
                        [5] = function()
                            if random(100) < 40 then
                                oko.afaze = random(5)
                            end
                        end,
                    }
                    oko.citac = oko.citac - 1
                    if oko.citac == 0 then
                        oko.cinnost = 0
                        oko.afaze = 0
                    end
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_qldik1()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        qldik1.afaze = 5
        qldik1.zije = 0
        qldik1.oci = 0

        return function()
            if qldik1.dir ~= dir_no then
                qldik1.zije = 1
            end
            if math.mod(count, 3) == 0 then
                if qldik1.zije > 0 then
                    if random(100) < 20 then
                        qldik1.oci = random(5)
                    end
                    if random(100) < 4 then
                        qldik1.afaze = 5
                    else
                        qldik1.afaze = qldik1.oci
                    end
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_qldik2()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        qldik2.afaze = 5
        qldik2.zije = 0
        qldik2.oci = 0

        return function()
            if qldik2.dir ~= dir_no then
                qldik2.zije = 1
            end
            if math.mod(count, 3) == 0 then
                if qldik2.zije > 0 then
                    if random(100) < 20 then
                        qldik2.oci = random(5)
                    end
                    if random(100) < 4 then
                        qldik2.afaze = 5
                    else
                        qldik2.afaze = qldik2.oci
                    end
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_qldik3()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        qldik3.oci = 0
        qldik3.skace = 0

        return function()
            if math.mod(count, 2) == 0 then
                if qldik3.skace == 0 then
                    if random(100) < 1 then
                        qldik3.skace = random(7) * 2 + 3
                    end
                    if random(100) < 4 then
                        qldik3.afaze = 5
                    else
                        if random(100) < 30 then
                            qldik3.oci = random(5)
                        end
                        qldik3.afaze = qldik3.oci
                    end
                else
                    if odd(qldik3.skace) then
                        qldik3.afaze = 6
                    else
                        qldik3.afaze = 7
                    end
                    qldik3.skace = qldik3.skace - 1
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_lahvac()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        lahvac.rozbit = 0
        lahvac.vnitrek = random(4)
        lahvac.stav = 0
        lahvac.smer = random(2)
        lahvac.pada = 0

        return function()
            switch(lahvac.rozbit){
                [0] = function()
                    if math.mod(count, 4) == 0 then
                        switch(random(4)){
                            [0] = function()
                                lahvac.vnitrek = math.mod(lahvac.vnitrek + 1, 4)
                            end,
                            [1] = function()
                                lahvac.vnitrek = math.mod(lahvac.vnitrek + 3, 4)
                            end,
                        }
                    end
                    switch(lahvac.stav){
                        [0] = function()
                            if random(100) < 5 then
                                lahvac.stav = 10 + random(2) * 10
                                lahvac.smer = 1 - lahvac.smer
                                lahvac.afaze = 0
                            elseif random(100) < 7 then
                                lahvac.stav = 1 + random(2)
                                lahvac.afaze = 7 + lahvac.stav * 4 + math.mod(lahvac.vnitrek, 2)
                            else
                                lahvac.afaze = lahvac.vnitrek
                            end
                        end,
                        [1, 2] = function()
                            if random(100) < 7 then
                                lahvac.afaze = 7 + lahvac.stav * 4 + math.mod(lahvac.vnitrek, 2)
                                lahvac.stav = 0
                            elseif random(100) < 7 and lahvac.stav == 2 then
                                lahvac.stav = 3
                                lahvac.afaze = 19
                            else
                                lahvac.afaze = 9 + 4 * lahvac.stav + math.mod(lahvac.vnitrek, 2)
                                if random(100) < 5 then
                                    dec(lahvac.afaze, 2)
                                end
                            end
                        end,
                        [3] = function()
                            if random(100) < 7 then
                                lahvac.stav = 2
                                lahvac.afaze = 15 + math.mod(lahvac.vnitrek, 2)
                            elseif random(100) < 7 then
                                lahvac.stav = 4
                                lahvac.afaze = 22 + math.mod(lahvac.vnitrek, 2)
                            elseif math.mod(lahvac.vnitrek, 2) == 1 and random(100) < 10 then
                                lahvac.afaze = 19
                            else
                                lahvac.afaze = 20 + math.mod(lahvac.vnitrek, 2)
                            end
                        end,
                        [4] = function()
                            if random(100) < 7 then
                                lahvac.stav = 3
                                lahvac.afaze = 20 + math.mod(lahvac.vnitrek, 2)
                            end
                        end,
                        [10.. --FIXME: range
15] = function()
                            if lahvac.smer == 0 then
                                lahvac.afaze = lahvac.stav - 5
                            else
                                lahvac.afaze = 25 - lahvac.stav - 5
                            end
                            if lahvac.stav == 15 then
                                lahvac.stav = 0
                            else
                                lahvac.stav = lahvac.stav + 1
                            end
                        end,
                        [20.. --FIXME: range
25] = function()
                            if math.mod(count, 3) == 0 then
                                if lahvac.smer == 0 then
                                    lahvac.afaze = lahvac.stav - 15
                                else
                                    lahvac.afaze = 45 - lahvac.stav - 15
                                end
                                if lahvac.stav == 25 then
                                    lahvac.stav = 0
                                else
                                    lahvac.stav = lahvac.stav + 1
                                end
                            end
                        end,
                    }
                    if lahvac.Dir == dir_down then
                        lahvac.pada = 1
                    elseif lahvac.pada == 1 then
                        lahvac.rozbit = 1
                    end
                end,
                [1.. --FIXME: range
4] = function()
                    lahvac.afaze = 23 + lahvac.rozbit
                    lahvac.rozbit = lahvac.rozbit + 1
                end,
                [5] = function()
                    lahvac.stav = random(30) + 30
                    lahvac.rozbit = lahvac.rozbit + 1
                end,
                [6] = function()
                    if lahvac.stav == 0 or lahvac.Dir == dir_left or lahvac.Dir == dir_right then
                        lahvac.rozbit = lahvac.rozbit + 1
                        lahvac.stav = 0
                    else
                        lahvac.stav = lahvac.stav - 1
                    end
                end,
                [7] = function()
                    if lahvac.Dir ~= dir_no then
                        lahvac.stav = random(10) + 10
                        lahvac.rozbit = 10
                        lahvac.afaze = 31 + random(3)
                    else
                        switch(lahvac.stav){
                            [0] = function()
                                if random(100) < 7 then
                                    lahvac.stav = 1 + random(2)
                                    if lahvac.stav == 1 then
                                        lahvac.afaze = 28
                                    else
                                        lahvac.afaze = 30
                                    end
                                else
                                    lahvac.afaze = 27
                                end
                            end,
                            [1] = function()
                                if random(100) < 7 then
                                    lahvac.stav = 0
                                    lahvac.afaze = 28
                                elseif random(100) < 5 then
                                    lahvac.afaze = 28
                                else
                                    lahvac.afaze = 29
                                end
                            end,
                            [2] = function()
                                if random(100) < 7 then
                                    lahvac.stav = 0
                                end
                            end,
                        }
                    end
                end,
                [10] = function()
                    if lahvac.stav == 0 then
                        lahvac.stav = random(10) + 10
                        lahvac.rozbit = 6
                        lahvac.afaze = 27
                    else
                        if odd(count) then
                            if random(2) == 0 then
                                lahvac.afaze = math.mod(lahvac.afaze - 30, 3) + 31
                            else
                                lahvac.afaze = math.mod(lahvac.afaze - 29, 3) + 31
                            end
                        end
                        lahvac.stav = lahvac.stav - 1
                    end
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_oka()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        oka.impuls = 0
        oka.kuk = 0
        oka.smer = 4

        return function()
            if oka.dir ~= dir_no then
                if oka.impuls == 0 then
                    oka.faze = 0
                end
                oka.impuls = 4
            end
            if oka.impuls > 0 then
                if oka.faze < oka.impuls then
                    oka.afaze = 7 + oka.faze
                else
                    oka.afaze = 15 - 2 * oka.impuls + oka.faze
                end
                oka.faze = oka.faze + 1
                if oka.faze == 2 * oka.impuls then
                    oka.faze = 0
                    oka.impuls = oka.impuls - 1
                end
            elseif oka.kuk > 0 then
                oka.afaze = 1
                oka.kuk = oka.kuk - 1
                oka.smer = 4
            else
                if aktivni == mala then
                    pom1 = xdist(@ --FIXME: addr
small, this)
                    pom2 = ydist(@ --FIXME: addr
small, this)
                elseif aktivni == velka then
                    pom1 = xdist(@ --FIXME: addr
big, this)
                    pom2 = ydist(@ --FIXME: addr
big, this)
                end
                if aktivni == mala or aktivni == velka then
                    if pom1 < 0 then
                        if abs(pom1) >= 2 * abs(pom2) then
                            oka.novysmer = 6
                        elseif abs(pom2) >= 2 * abs(pom1) then
                            oka.novysmer = 4
                        else
                            oka.novysmer = 5
                        end
                    else
                        if abs(pom1) >= 2 * abs(pom2) then
                            oka.novysmer = 2
                        elseif abs(pom2) >= 2 * abs(pom1) then
                            oka.novysmer = 4
                        else
                            oka.novysmer = 3
                        end
                    end
                end
                if oka.smer == -1 then
                    oka.smer = oka.novysmer
                elseif oka.smer < oka.novysmer then
                    oka.smer = oka.smer + 1
                elseif oka.smer > oka.novysmer then
                    oka.smer = oka.smer - 1
                end
                oka.afaze = oka.smer
                if random(200) < 1 then
                    oka.kuk = random(4) + 4
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_malej()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        malej.houpe = 0
        malej.oci = 0

        return function()
            if math.mod(count, 3) == 0 then
                if random(100) < 10 then
                    malej.oci = random(5)
                end
            end
            if malej.dir ~= dir_no and malej.houpe == 0 then
                malej.faze = 0
                malej.houpe = 1
            end
            switch(malej.houpe){
                [0] = function()
                    if random(100) < 2 then
                        malej.afaze = 4
                    else
                        malej.afaze = malej.oci
                    end
                end,
                [1] = function()
                    malej.faze = malej.faze + 1
                    switch(malej.faze){
                        [1] = function()
                            malej.afaze = 5
                        end,
                        [4] = function()
                            malej.afaze = 6
                        end,
                        [6] = function()
                            if malej.dir == dir_no then
                                malej.houpe = 0
                                malej.oci = 0
                            else
                                malej.faze = 0
                            end
                        end,
                    }
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_ruka()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        ruka.cinnost = 0
        ruka.smer = 0
        ruka.faze = 0

        return function()
            if odd(count) then
                pomb1 = xdist(this, @ --FIXME: addr
small) == 0 and ydist(this, @ --FIXME: addr
small) > 0 and ydist(this, @ --FIXME: addr
small) < 10
                pomb2 = xdist(this, @ --FIXME: addr
big) == 0 and ydist(this, @ --FIXME: addr
big) > 0 and ydist(this, @ --FIXME: addr
big) < 10
                if pomb1 and pomb2 then
                    if small.Y > big.Y then
                        pomb2 = false
                    end
                end
                if pomb1 or pomb2 then
                    if ruka.cinnost ~= 2 then
                        ruka.faze = 0
                    end
                    ruka.cinnost = 2
                    if pomb1 then
                        if natoceni[mala] == smer_vlevo then
                            ruka.smer = 0
                        else
                            ruka.smer = 1
                        end
                    elseif natoceni[velka] == smer_vlevo then
                        ruka.smer = 0
                    else
                        ruka.smer = 1
                    end
                elseif ruka.cinnost == 2 then
                    ruka.cinnost = 0
                    ruka.faze = 0
                end
                switch(ruka.cinnost){
                    [0] = function()
                        if random(100) < 2 then
                            ruka.cinnost = 1
                            ruka.afaze = 0
                            ruka.faze = (random(3) + 2) * 2
                        else
                            if random(100) < 3 then
                                ruka.smer = 1 - ruka.smer
                            end
                            if ruka.smer == 0 then
                                ruka.faze = math.mod(ruka.faze + 1, 7)
                            else
                                ruka.faze = math.mod(ruka.faze + 6, 7)
                            end
                            ruka.afaze = ruka.faze
                        end
                    end,
                    [1] = function()
                        ruka.faze = ruka.faze - 1
                        if odd(ruka.faze) then
                            ruka.afaze = 7
                        else
                            ruka.afaze = 0
                        end
                        if ruka.faze == 0 then
                            ruka.cinnost = 0
                        end
                    end,
                    [2] = function()
                        ruka.faze = 1 - ruka.faze
                        ruka.afaze = 8 + ruka.faze + ruka.smer * 2
                    end,
                }
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_pldicek()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        pldicek.pocet = 0
        InitPldici(@ --FIXME: addr
pldicek, pldicek.pocet)

        return function()
            PrgPldici(@ --FIXME: addr
pldicek, pldicek.pocet)
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_mutant()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false


        return function()
            if odd(count) then
                if dvere1.dir == dir_no and dvere2.dir == dir_no then
                    switch(mutant.afaze){
                        [0.. --FIXME: range
4] = function()
                            switch(random(20)){
                                [0] = function()
                                    mutant.afaze = 5
                                end,
                                [1.. --FIXME: range
3] = function()
                                    mutant.afaze = random(5)
                                end,
                            }
                        end,
                        [5, 9] = function()
                            if random(4) == 2 then
                                mutant.afaze = 5 + random(5)
                            else
                                switch(random(20)){
                                    [0.. --FIXME: range
1] = function()
                                        mutant.afaze = random(5)
                                    end,
                                    [2.. --FIXME: range
7] = function()
                                        mutant.afaze = 6 + random(3)
                                    end,
                                }
                            end
                        end,
                    }
                else
                    mutant.afaze = 9
                end
            end
        end
    end

    -- --------------------
    local update_table = {}
    local subinit
    subinit = prog_init_room()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_klicka()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_zataras()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_horni1()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_dolni1()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_zkum()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_horni2()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_dolni2()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_kostra()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_oko()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_qldik1()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_qldik2()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_qldik3()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_lahvac()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_oka()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_malej()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_ruka()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_pldicek()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_mutant()
    if subinit then
        table.insert(update_table, subinit)
    end
    return update_table
end
local update_table = prog_init()


-- -----------------------------------------------------------------
-- Update
-- -----------------------------------------------------------------
function prog_update()
    for key, subupdate in pairs(update_table) do
        subupdate()
    end
end

