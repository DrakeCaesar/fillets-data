
-- -----------------------------------------------------------------
-- Init
-- -----------------------------------------------------------------
local function prog_init()
    initModels()
    sound_playMusic("music/rybky02.ogg")
    local pokus = getRestartCount()


    -- -------------------------------------------------------------
    local function prog_init_room()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        room.bliknul = 0
        room.last = random(2)
        room.rpesmala = 0
        room.rpesvelka = 0
        room.nerusit = 0
        room.pesmluvi = 0

        return function()
            if no_dialog() and isReady(small) and isReady(big) then
                if gspec == 2 and room.tma > 0 then
                    room.tma = room.tma - 1
                end
                if gspec ~= 2 then
                    room.tma = random(100) + 50
                end
                if room.bliknul == 1 then
                    room.bliknul = room.bliknul + 1
                    addm(random(10) + 10, "ch-m-rozsvit" + chr(random(3) + 48))
                    addv(random(15) + 2, "ch-v-pockej" + chr(random(3) + 48))
                elseif room.bliknul == 3 then
                    room.bliknul = room.bliknul + 1
                    addm(random(10), "ch-m-blik" + chr(random(2) + 49))
                    room.oci = room.bliknul + 2
                elseif room.oci < room.bliknul and room.oci > 0 then
                    if random(100) < 40 then
                        room.oci = 0
                        addm(3, "ch-m-blik0")
                    else
                        room.oci = room.bliknul
                    end
                elseif room.tma == 0 then
                    room.tma = random(300) + 100
                    if random(100) < 80 then
                        room.last = 1 - room.last
                    end
                    switch(room.last){
                        [0] = function()
                            addv(0, "ch-v-halo" + chr(random(3) + 48))
                            addm(random(20), "ch-m-tady" + chr(random(3) + 48))
                        end,
                        [1] = function()
                            addm(0, "ch-m-bojim" + chr(random(3) + 48))
                            addv(random(20), "ch-v-neboj" + chr(random(3) + 48))
                        end,
                    }
                elseif room.rpesvelka == 0 and gstav ~= 2 and big.Y >= 20 and random(100) < 2 then
                    room.rpesvelka = 1
                    room.nerusit = 1
                    pom1 = random(4) + 48
                    addv(10, "ch-v-robopes")
                    addm(random(5), "ch-m-ten")
                    addv(random(10), "ch-v-zapada")
                    addm(5 + random(10), "ch-m-odpoved" + chr(pom1))
                    if random(100) < 70 then
                        addv(random(20) + 10, "ch-v-smysl")
                        if random(100) < 80 then
                            addm(random(10) + 5, "ch-m-vubec")
                        end
                    end
                    room.cpsa = random(2)
                    addd(random(20), "ch-r-nevsimej" + chr(random(3) + 48), 10, room.pesmluvi)
                    addd(random(20), "ch-r-hracka", 10, room.pesmluvi)
                    addd(10 + random(20), "ch-r-ikdyz" + chr(random(4) + 48), 10, room.pesmluvi)
                    addd(10 + random(20), "ch-r-anavic" + chr(pom1), 10, room.pesmluvi)
                    addset(room.nerusit, 0)
                elseif room.rpesmala == 0 and small.Y >= 28 and (small.X <= 11 or small.X >= 20) and random(100) < 3 then
                    if room.rpesvelka == 1 and random(3) < 2 then
                        addv(2, "ch-v-pozor")
                    else
                        addm(2, "ch-m-doufam")
                    end
                    room.rpesmala = 1
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_rightpes()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        rightpes.faze = 0

        return function()
            if rightpes.faze == 2 then
                rightpes.faze = 0
            else
                rightpes.faze = rightpes.faze + 1
            end
            if gspec == 2 then
                rightpes.afaze = rightpes.faze + 3
                spec = 2
            else
                rightpes.afaze = rightpes.faze
                spec = 0
                if room.pesmluvi ~= 0 and room.cpsa == 1 and random(2) == 0 then
                    rightpes.afaze = rightpes.afaze + 6
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_leftpes()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        leftpes.faze = 0

        return function()
            if leftpes.faze == 2 then
                leftpes.faze = 0
            else
                leftpes.faze = leftpes.faze + 1
            end
            if gspec == 2 then
                leftpes.afaze = leftpes.faze + 3
                spec = 2
            else
                leftpes.afaze = leftpes.faze
                spec = 0
                if room.pesmluvi ~= 0 and room.cpsa == 0 and random(2) == 0 then
                    leftpes.afaze = leftpes.afaze + 6
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_vypinac()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        vypinac.stav = 0
        gspec = 0
        spec = 2

        return function()
            switch(vypinac.stav){
                [0] = function()
                    if (vypinac.Dir == dir_left or vypinac.Dir == dir_right) and gfaze == 0 then
                        vypinac.stav = vypinac.stav + 1
                        vypinac.afaze = 1
                        Talk("ch-x-click1", 200)
                    end
                end,
                [1] = function()
                    vypinac.stav = vypinac.stav + 1
                    vypinac.afaze = 2
                    gspec = 2
                    ToRecord("x")
                    ToRecord("2")
                    room.bliknul = room.bliknul + 1
                    if room.nerusit == 0 then
                        zrus_dialogy()
                    end
                end,
                [2] = function()
                    if (vypinac.Dir == dir_left or vypinac.Dir == dir_right) and gfaze == 0 then
                        vypinac.stav = 0
                        vypinac.afaze = 0
                        gspec = 0
                        Talk("ch-x-click2", 200)
                        ToRecord("x")
                        ToRecord("0")
                        room.bliknul = room.bliknul + 1
                        if room.nerusit == 0 then
                            zrus_dialogy()
                        end
                    end
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_dvere1()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        dvere1.faze = 0
        dvere1.pocit = 2

        return function()
            if dvere1.pocit > 0 then
                dvere1.pocit = dvere1.pocit - 1
            else
                dvere1.pocit = 5
                dvere1.faze = 1 - dvere1.faze
            end
            if gspec == 2 then
                dvere1.afaze = dvere1.faze + 2
                spec = 2
            else
                dvere1.afaze = dvere1.faze
                spec = 0
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_dvere2()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        dvere2.faze = 0
        dvere2.pocit = 1

        return function()
            if dvere2.pocit > 0 then
                dvere2.pocit = dvere2.pocit - 1
            else
                dvere2.pocit = 1
                dvere2.faze = 1 - dvere2.faze
            end
            if gspec == 2 then
                dvere2.afaze = dvere2.faze + 2
                spec = 2
            else
                dvere2.afaze = dvere2.faze
                spec = 0
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_dvere3()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        dvere3.faze = 0
        dvere3.pocit = 2

        return function()
            if dvere3.pocit > 0 then
                dvere3.pocit = dvere3.pocit - 1
            else
                dvere3.pocit = 4
                dvere3.faze = 1 - dvere3.faze
            end
            if gspec == 2 then
                dvere3.afaze = dvere3.faze + 2
                spec = 2
            else
                dvere3.afaze = dvere3.faze
                spec = 0
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_dvere4()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        dvere4.faze = 0
        dvere4.pocit = 1

        return function()
            if dvere4.pocit > 0 then
                dvere4.pocit = dvere4.pocit - 1
            else
                dvere4.pocit = 2
                dvere4.faze = 1 - dvere4.faze
            end
            if gspec == 2 then
                dvere4.afaze = dvere4.faze + 2
                spec = 2
            else
                dvere4.afaze = dvere4.faze
                spec = 0
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_poklop2()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        poklop2.faze = 1
        poklop2.pocit = 1

        return function()
            if poklop2.pocit > 0 then
                poklop2.pocit = poklop2.pocit - 1
            else
                poklop2.pocit = 3
                poklop2.faze = 1 - poklop2.faze
            end
            if gspec == 2 then
                poklop2.afaze = poklop2.faze + 2
                spec = 2
            else
                poklop2.afaze = poklop2.faze
                spec = 0
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_poklop1()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        poklop1.faze = 0
        poklop1.pocit = 1

        return function()
            if poklop1.pocit > 0 then
                poklop1.pocit = poklop1.pocit - 1
            else
                poklop1.pocit = 3
                poklop1.faze = 1 - poklop1.faze
            end
            if gspec == 2 then
                poklop1.afaze = poklop1.faze + 2
                spec = 2
            else
                poklop1.afaze = poklop1.faze
                spec = 0
            end
        end
    end

    -- --------------------
    local update_table = {}
    local subinit
    subinit = prog_init_room()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_rightpes()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_leftpes()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_vypinac()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_dvere1()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_dvere2()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_dvere3()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_dvere4()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_poklop2()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_poklop1()
    if subinit then
        table.insert(update_table, subinit)
    end
    return update_table
end
local update_table = prog_init()


-- -----------------------------------------------------------------
-- Update
-- -----------------------------------------------------------------
function prog_update()
    for key, subupdate in pairs(update_table) do
        subupdate()
    end
end

