
-- -----------------------------------------------------------------
-- Init
-- -----------------------------------------------------------------
local function prog_init()
    initModels()
    sound_playMusic("music/rybky06.ogg")
    local pokus = getRestartCount()


    -- -------------------------------------------------------------
    local function prog_init_room()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        room.odjel = 0
        room.qopatrne = 0
        room.hulakat = random(30) + 10 * pokus
        room.oci = 0
        room.reklopatrne = 0

        return function()
            if talking(mluvi_mala) or talking(mluvi_velka) then
                room.hulakat = -1
            end
            if room.odjel == 0 and venku[velka] and isReady(small) then
                room.odjel = 1
                switch(random(3)){
                    [0] = function()
                        addm(10, "zr-m-takfajn")
                    end,
                    [1] = function()
                        addm(10, "zr-m-tojeon")
                    end,
                    [2] = function()
                        addm(10, "zr-m-pockej")
                    end,
                }
            elseif room.qopatrne < 2 and room.reklopatrne == 1 and not isReady(small) and small.X == 8 and isReady(big) then
                addv(3, "zr-v-vzdyt")
                room.qopatrne = 2
            end
            if room.qopatrne < 2 then
                if isReady(small) and small.X == 9 and isReady(big) and lahev.X == 8 and natoceni[mala] == smer_vlevo and room.qopatrne == 0 then
                    if no_dialog() then
                        addv(1, "zr-v-opatrne")
                        room.reklopatrne = 1
                    else
                        room.reklopatrne = 0
                    end
                    room.qopatrne = 1
                end
            end
            if room.qopatrne == 1 and natoceni[mala] == smer_vpravo then
                room.qopatrne = 0
            end
            if isReady(small) and not venku[mala] and isReady(big) and not venku[velka] and no_dialog() then
                if room.hulakat > 0 then
                    room.hulakat = room.hulakat - 1
                elseif room.hulakat == 0 then
                    room.hulakat = -1
                    switch(random(3)){
                        [0] = function()
                            addv(3, "zr-v-hej")
                        end,
                        [1] = function()
                            addv(3, "zr-v-halo")
                        end,
                        [2] = function()
                            addv(3, "zr-v-jetunekdo")
                        end,
                    }
                    switch(random(3)){
                        [0] = function()
                            addm(9, "zr-m-nervi")
                        end,
                        [1] = function()
                            addm(9, "zr-m-nepovykuj")
                        end,
                        [2] = function()
                            addm(9, "zr-m-tadyjsem")
                        end,
                    }
                end
                if no_dialog() and small.trpelivost == 0 then
                    switch(random(2)){
                        [0] = function()
                            addm(0, "zr-m-obliceje")
                        end,
                        [1] = function()
                            addm(0, "zr-m-prestan")
                        end,
                    }
                    small.trpelivost = random(600) + 100
                end
                if no_dialog() and peri.cinnost == 7 and room.oci == 0 and random(100) < 50 then
                    addm(5, "zr-m-komu")
                    addv(10, "zr-v-nevim")
                    room.oci = 1
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_peri()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        peri.cinnost = 0

        return function()
            switch(peri.cinnost){
                [0] = function()
                    peri.delay = random(100) + 50
                    peri.cinnost = 1
                    peri.afaze = 0
                end,
                [1] = function()
                    if peri.delay == 0 then
                        peri.cinnost = peri.cinnost + 1
                    else
                        peri.delay = peri.delay - 1
                    end
                end,
                [2.. --FIXME: range
7] = function()
                    peri.afaze = peri.cinnost - 1
                    peri.cinnost = peri.cinnost + 1
                end,
                [8] = function()
                    peri.delay = random(30) + 15
                    peri.cinnost = peri.cinnost + 1
                end,
                [9] = function()
                    if math.mod(count, 3) == 0 then
                        peri.afaze = 6 + random(2)
                    end
                    if peri.delay == 0 then
                        peri.cinnost = peri.cinnost + 1
                    else
                        peri.delay = peri.delay - 1
                    end
                end,
                [10] = function()
                    if random(100) < 30 then
                        peri.cinnost = 20
                    else
                        peri.cinnost = peri.cinnost + 1
                    end
                end,
                [11] = function()
                    peri.delay = random(5) + 2
                    peri.cinnost = peri.cinnost + 1
                end,
                [12] = function()
                    if random(100) < 20 then
                        peri.cinnost = peri.cinnost + 1
                    end
                end,
                [13.. --FIXME: range
15] = function()
                    peri.afaze = 18 - peri.cinnost
                    peri.cinnost = peri.cinnost + 1
                end,
                [16.. --FIXME: range
18] = function()
                    peri.afaze = peri.cinnost - 12
                    peri.cinnost = peri.cinnost + 1
                end,
                [19] = function()
                    if peri.delay == 0 then
                        peri.cinnost = 8
                    else
                        peri.delay = peri.delay - 1
                        peri.cinnost = 12
                    end
                end,
                [20.. --FIXME: range
25] = function()
                    peri.afaze = 25 - peri.cinnost
                    peri.cinnost = peri.cinnost + 1
                end,
                [26] = function()
                    peri.cinnost = 0
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_zrcadlo()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        spec = 1

    end

    -- -------------------------------------------------------------
    local function prog_init_naboj()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        naboj.nabita = 0

        return function()
            if naboj.nabita == 0 and x == 12 and y == 8 then
                naboj.nabita = 1
                Talk("zr-x-nabito", 201)
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_small()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        small.trpelivost = random(50) + 30

        return function()
            if natoceni[mala] == smer_vpravo and (xdist(this, @ --FIXME: addr
zrcadlo) == -1 or xdist(this, @ --FIXME: addr
zrcadlo) == -2) and ydist(this, @ --FIXME: addr
zrcadlo) == 0 then
                if random(100) < 30 then
                    xicht[mala] = random(9)
                else
                end
            else
                xicht[mala] = 0
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_big()
        return function()
            if natoceni[velka] == smer_vpravo and (xdist(this, @ --FIXME: addr
zrcadlo) == -1 or xdist(this, @ --FIXME: addr
zrcadlo) == -2) and (zrcadlo.Y == big.Y or zrcadlo.Y == big.Y - 1) then
                if random(100) < 30 then
                    xicht[velka] = random(8)
                end
                if small.trpelivost > 0 then
                    small.trpelivost = small.trpelivost - 1
                end
            else
                xicht[velka] = 0
            end
        end
    end

    -- --------------------
    local update_table = {}
    local subinit
    subinit = prog_init_room()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_peri()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_zrcadlo()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_naboj()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_small()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_big()
    if subinit then
        table.insert(update_table, subinit)
    end
    return update_table
end
local update_table = prog_init()


-- -----------------------------------------------------------------
-- Update
-- -----------------------------------------------------------------
function prog_update()
    for key, subupdate in pairs(update_table) do
        subupdate()
    end
end

