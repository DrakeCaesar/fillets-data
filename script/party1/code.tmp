
-- -----------------------------------------------------------------
-- Init
-- -----------------------------------------------------------------
local function prog_init()
    initModels()
    sound_playMusic("music/rybky15.ogg")
    local pokus = getRestartCount()


    -- -------------------------------------------------------------
    local function prog_init_room()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        room.uvod1 = 0
        room.uvod2 = 0
        room.nevylit = 0
        room.ovalci = 0
        if random(100) >= 130 - pokus * 30 then
            room.uvod1 = 2
        end
        if random(100) >= 130 - pokus * 30 then
            room.uvod2 = 2
        end
        if random(100) >= 120 - pokus * 20 then
            room.nevylit = 2
        end
        if random(100) >= 120 - pokus * 20 then
            room.ovalci = 2
        end
        if room.uvod2 == 0 then
            globpole[1] = 1
            globpole[2] = 1
        else
            globpole[1] = 0
            globpole[2] = 0
        end
        room.bojise = 0

        return function()
            if no_dialog() and isReady(small) and isReady(big) then
                pomb1 = false
                for pom1 = (@ --FIXME: addr
sklenka), (@ --FIXME: addr
sklenka) + 8 do
                    --FIXME: WITH
                    with --FIXME: pointer
Items[pom1]^ do
                        if room.dir == dir_left or room.dir == dir_right then
                            pomb1 = true
                        end
                    end
                end
                pomb2 = false
                for pom1 = (@ --FIXME: addr
sklenka), (@ --FIXME: addr
sklenka) + 7 do
                    --FIXME: WITH
                    with --FIXME: pointer
Items[pom1]^ do
                        if room.Y == 27 and room.X == 36 and ocel.X == 37 then
                            pomb2 = true
                        end
                    end
                end
                if room.uvod1 == 0 then
                    addm(random(20) + 20, "pt1-m-parnicek")
                    room.uvod1 = 1
                elseif room.uvod2 == 0 then
                    addv(random(20) + 20, "pt1-v-predtucha")
                    addm(0, "pt1-m-predtucha")
                    addset(globpole[1], 0)
                    addset(globpole[2], 0)
                    room.uvod2 = 1
                elseif room.uvod2 == 1 and (globpole[1] ~= 0 or globpole[2] ~= 0) then
                    room.uvod2 = 2
                    addm(10 + random(10), "pt1-m-kostlivec")
                elseif room.bojise == 0 and room.uvod2 == 2 and (globpole[1] ~= 0 or globpole[2] ~= 0) and random(1000) < 3 then
                    room.bojise = 1
                    addm(20, "pt1-m-vylezt" + chr(48 + random(3)))
                    addv(random(10) + 5, "pt1-v-pryc" + chr(48 + random(2)))
                elseif room.ovalci == 0 and pomb2 then
                    room.ovalci = 1
                    addv(3, "pt1-v-valec")
                    addm(random(5), "pt1-m-nemuzu")
                elseif room.nevylit == 0 and pomb1 and random(100) < 1 then
                    room.nevylit = 1
                    addv(0, "pt1-v-pozor")
                end
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_frkavec()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        frkavec.cinnost = 0
        spec = 11

        return function()
            switch(frkavec.okno){
                [1] = function()
                    x = kabina.x + 2
                end,
                [2] = function()
                    x = kabina.x + 8
                end,
            }
            if frkavec.cinnost > 0 then
                spec = frkavec.strana * 10
            else
                spec = 11
            end
            switch(frkavec.cinnost){
                [0] = function()
                    if random(1000) < 8 then
                        frkavec.okno = random(2) + 1
                        if globpole[frkavec.okno] == 0 then
                            frkavec.cinnost = 1
                            frkavec.faze = 0
                            frkavec.strana = random(2)
                            globpole[frkavec.okno] = 1
                        end
                    end
                end,
                [1] = function()
                    switch(frkavec.faze){
                        [0.. --FIXME: range
4] = function()
                            frkavec.afaze = frkavec.faze
                            frkavec.faze = frkavec.faze + 1
                        end,
                        [5] = function()
                            frkavec.afaze = 5
                            frkavec.delay = random(10) + 5
                            frkavec.faze = frkavec.faze + 1
                        end,
                        [6] = function()
                            if frkavec.delay > 0 then
                                frkavec.delay = frkavec.delay - 1
                            else
                                frkavec.afaze = 6
                                frkavec.delay = 10
                                frkavec.faze = frkavec.faze + 1
                            end
                        end,
                        [7] = function()
                            if frkavec.delay > 0 then
                                frkavec.delay = frkavec.delay - 1
                            else
                                frkavec.afaze = 5
                                if random(100) < 75 then
                                    frkavec.delay = 2 + random(10)
                                    frkavec.faze = 6
                                else
                                    frkavec.faze = frkavec.faze + 1
                                end
                            end
                        end,
                        [8] = function()
                            frkavec.faze = frkavec.faze + 1
                        end,
                        [9] = function()
                            globpole[frkavec.okno] = 0
                            frkavec.faze = frkavec.faze + 1
                        end,
                        [10.. --FIXME: range
14] = function()
                            frkavec.afaze = 14 - frkavec.faze
                            frkavec.faze = frkavec.faze + 1
                            if frkavec.faze == 15 then
                                frkavec.cinnost = 0
                            end
                        end,
                    }
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_dama()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        spec = 11
        dama.kdeje = random(3)
        dama.cinnost = 0

        return function()
            switch(dama.okno){
                [1] = function()
                    x = kabina.x + 2
                end,
                [2] = function()
                    x = kabina.x + 8
                end,
            }
            if dama.cinnost > 0 then
                spec = dama.strana * 10
            else
                spec = 11
            end
            switch(dama.cinnost){
                [0] = function()
                    if random(1000) < 8 then
                        switch(dama.kdeje){
                            [0] = function()
                                dama.okno = 1
                                dama.strana = 1
                                dama.kdebude = 1
                            end,
                            [1] = function()
                                dama.strana = random(2)
                                dama.okno = dama.strana + 1
                                dama.kdebude = dama.strana * 2
                            end,
                            [2] = function()
                                dama.okno = 2
                                dama.strana = 0
                                dama.kdebude = 1
                            end,
                        }
                        if globpole[dama.okno] == 0 then
                            globpole[dama.okno] = 1
                            dama.cinnost = random(2) + 1
                            dama.faze = 0
                            dama.delay = 3
                        end
                    end
                end,
                [1.. --FIXME: range
2] = function()
                    switch(dama.faze){
                        [0.. --FIXME: range
14] = function()
                            dama.afaze = dama.faze
                            if dama.delay > 0 then
                                dama.delay = dama.delay - 1
                            else
                                dama.delay = 3
                                dama.faze = dama.faze + 1
                                if dama.faze == 7 and dama.cinnost == 2 then
                                    dama.faze = 20
                                end
                            end
                            if dama.faze == 15 then
                                dama.cinnost = 0
                                globpole[dama.okno] = 0
                                dama.kdeje = dama.kdebude
                            end
                        end,
                        [20.. --FIXME: range
23] = function()
                            dama.faze = dama.faze + 1
                        end,
                        [24.. --FIXME: range
27] = function()
                            dama.afaze = 15
                            dama.faze = dama.faze + 1
                        end,
                        [28.. --FIXME: range
29] = function()
                            dama.afaze = 6
                            dama.faze = dama.faze + 1
                        end,
                        [30] = function()
                            dama.faze = 7
                        end,
                    }
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_kapitan()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        spec = 11
        kapitan.kdeje = random(3)
        kapitan.cinnost = 0

        return function()
            switch(kapitan.okno){
                [1] = function()
                    x = kabina.x + 2
                end,
                [2] = function()
                    x = kabina.x + 8
                end,
            }
            if kapitan.cinnost > 0 then
                spec = (1 - kapitan.strana) * 10
            else
                spec = 11
            end
            switch(kapitan.cinnost){
                [0] = function()
                    if random(1000) < 8 then
                        switch(kapitan.kdeje){
                            [0] = function()
                                kapitan.okno = 1
                                kapitan.strana = 1
                                kapitan.kdebude = 1
                            end,
                            [1] = function()
                                kapitan.strana = random(2)
                                kapitan.okno = kapitan.strana + 1
                                kapitan.kdebude = kapitan.strana * 2
                            end,
                            [2] = function()
                                kapitan.okno = 2
                                kapitan.strana = 0
                                kapitan.kdebude = 1
                            end,
                        }
                        if globpole[kapitan.okno] == 0 then
                            globpole[kapitan.okno] = 1
                            kapitan.cinnost = random(2) + 1
                            kapitan.faze = 0
                            kapitan.delay = 2
                        end
                    end
                end,
                [1.. --FIXME: range
2] = function()
                    switch(kapitan.faze){
                        [0.. --FIXME: range
14] = function()
                            kapitan.afaze = kapitan.faze
                            if kapitan.delay > 0 then
                                kapitan.delay = kapitan.delay - 1
                            else
                                kapitan.delay = 2
                                kapitan.faze = kapitan.faze + 1
                                if kapitan.faze == 8 and kapitan.cinnost == 2 then
                                    kapitan.faze = 20
                                end
                            end
                            if kapitan.faze == 15 then
                                kapitan.cinnost = 0
                                globpole[kapitan.okno] = 0
                                kapitan.kdeje = kapitan.kdebude
                            end
                        end,
                        [20.. --FIXME: range
23] = function()
                            kapitan.afaze = kapitan.faze - 20 + 15
                            kapitan.faze = kapitan.faze + 1
                        end,
                        [24.. --FIXME: range
27] = function()
                            kapitan.afaze = 27 - kapitan.faze + 15
                            kapitan.faze = kapitan.faze + 1
                        end,
                        [28] = function()
                            kapitan.faze = 8
                        end,
                    }
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_lodnik()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        spec = 11
        lodnik.kdeje = random(3)
        lodnik.cinnost = 0

        return function()
            switch(lodnik.okno){
                [1] = function()
                    x = kabina.x + 2
                end,
                [2] = function()
                    x = kabina.x + 8
                end,
            }
            if lodnik.cinnost > 0 then
                spec = lodnik.strana * 10
            else
                spec = 11
            end
            switch(lodnik.cinnost){
                [0] = function()
                    if random(1000) < 8 then
                        switch(lodnik.kdeje){
                            [0] = function()
                                lodnik.okno = 1
                                lodnik.strana = 1
                                lodnik.kdebude = 1
                            end,
                            [1] = function()
                                lodnik.strana = random(2)
                                lodnik.okno = lodnik.strana + 1
                                lodnik.kdebude = lodnik.strana * 2
                            end,
                            [2] = function()
                                lodnik.okno = 2
                                lodnik.strana = 0
                                lodnik.kdebude = 1
                            end,
                        }
                        if globpole[lodnik.okno] == 0 then
                            globpole[lodnik.okno] = 1
                            lodnik.cinnost = random(2) + 1
                            lodnik.faze = 0
                            lodnik.delay = (lodnik.cinnost - 1) * 2
                        end
                    end
                end,
                [1] = function()
                    switch(lodnik.faze){
                        [0.. --FIXME: range
9] = function()
                            lodnik.afaze = lodnik.faze
                            if lodnik.delay > 0 then
                                lodnik.delay = lodnik.delay - 1
                            else
                                lodnik.delay = 1 + (lodnik.cinnost - 1) * 2
                                lodnik.faze = lodnik.faze + 1
                            end
                            if lodnik.faze == 10 then
                                lodnik.cinnost = 0
                                globpole[lodnik.okno] = 0
                                lodnik.kdeje = lodnik.kdebude
                            end
                        end,
                    }
                end,
                [2] = function()
                    switch(lodnik.faze){
                        [0.. --FIXME: range
12] = function()
                            lodnik.afaze = lodnik.faze + 10
                            if lodnik.delay > 0 then
                                lodnik.delay = lodnik.delay - 1
                            else
                                lodnik.delay = 1 + (lodnik.cinnost - 1) * 2
                                lodnik.faze = lodnik.faze + 1
                            end
                            if lodnik.faze == 13 then
                                lodnik.cinnost = 0
                                globpole[lodnik.okno] = 0
                                lodnik.kdeje = lodnik.kdebude
                            end
                        end,
                    }
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_sklenka()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        for pom1 = 0, 8 do
            globpole[1000 + pom1] = 0
        end

        return function()
            for pom1 = 0, 8 do
                --FIXME: WITH
                with --FIXME: pointer
Items[(@ --FIXME: addr
sklenka) + pom1]^ do
                    pom2 = globpole[1000 + pom1]
                    if sklenka.dir ~= dir_no then
                        if pom2 == 0 then
                            pom2 = 9
                        elseif pom2 <= 6 then
                            inc(pom2, 6)
                        end
                    end
                    if pom2 == 0 then
                        sklenka.afaze = 0
                    else
                        pom2 = pom2 - 1
                        sklenka.afaze = 2 - math.mod(math.floor(pom2 / 3), 2)
                    end
                    globpole[1000 + pom1] = pom2
                end
            end
        end
    end

    -- --------------------
    local update_table = {}
    local subinit
    subinit = prog_init_room()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_frkavec()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_dama()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_kapitan()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_lodnik()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_sklenka()
    if subinit then
        table.insert(update_table, subinit)
    end
    return update_table
end
local update_table = prog_init()


-- -----------------------------------------------------------------
-- Update
-- -----------------------------------------------------------------
function prog_update()
    for key, subupdate in pairs(update_table) do
        subupdate()
    end
end

