
-- -----------------------------------------------------------------
-- Init
-- -----------------------------------------------------------------
local function prog_init()
    initModels()
    sound_playMusic("music/rybky06.ogg")
    local pokus = getRestartCount()


    -- -------------------------------------------------------------
    local function prog_init_room()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        gspec = 9
        room.poh = 0
        room.obec = 1000 + random(3000)
        room.utb = 0

        return function()
            pom2 = 0
            if no_dialog() and isReady(small) and isReady(big) then
                if StdKrajniHlaska then
                    addv(10, "map-v-ukol")
                    StdKonecKrajniHlasky()
                elseif count == 10 + pokus then
                    pom2 = 1
                elseif room.poh == 0 and mapous.x ~= mapous.xstart then
                    pom2 = 6
                    room.poh = 1
                elseif room.utb == 0 and (mapous.x IN --FIXME: IN
{1, 2, 28}) then
                    room.utb = 1
                    pom2 = 7
                elseif room.obec > 0 then
                    room.obec = room.obec - 1
                else
                    room.obec = 1000 + random(1000 + math.floor(count / 5))
                    pom2 = random(4) + 2
                end
            end
            switch(pom2){
                [1] = function()
                    if random(3) > 0 then
                        addv(7, "map-v-mapa")
                    else
                        addm(7, "map-m-mapa")
                    end
                    if pokus < 4 or random(100) < 60 then
                        addm(7, "map-m-ukol")
                        addv(7, "map-v-jasne")
                        addm(7, "map-m-neplacej")
                    end
                end,
                [2] = function()
                    addv(7, "map-v-cojetam")
                    addv(7, "map-v-poklady")
                    addm(7, "map-m-uvidime")
                end,
                [3] = function()
                    addm(7, "map-m-sne" + "ci")
                    addd(8, "map-x-hlemyzdi", 111, sneci.mluvi)
                end,
                [4] = function()
                    addv(8, "map-v-oci")
                end,
                [5] = function()
                    addv(8, "map-v-restart")
                    addm(8, "map-m-pravidla")
                end,
                [6] = function()
                    addm(7, "map-m-pohnout")
                    addv(7, "map-v-dal")
                end,
                [7] = function()
                    addm(7, "map-m-uz")
                end,
            }
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_mapous()
        return function()
            Spec9(this, 7, 4)
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_voko1()
        return function()
            for pom1 = 0, 1 do
                if (--FIXME: pointer
Items[this + pom1]^).anim == "" then
                    switch(random(7)){
                        [0] = function()
                            setanim(this + pom1, "d10-99a1d?2-3a2d?2-3a1d?2-3a2d?2-3a1d?2-3a2d?2-3a1d?2-3a2d?2-3a0")
                        end,
                        [1] = function()
                            setanim(this + pom1, "d10-99a3d?2-3a4d?2-3a3d?2-3a4d?2-3a3d?2-3a4d?2-3a3d?2-3a4d?2-3a0")
                        end,
                        [2, 3] = function()
                            setanim(this + pom1, "d10-99a?1-4d10-30a0")
                        end,
                        [4, 5] = function()
                            setanim(this + pom1, "d10-99a3a1a4a1a3a2a4a1a3a1a4a1a3a1a4a1a0")
                        end,
                        [6] = function()
                            setanim(this + pom1, "d10-99a?0-4d2-8a?0-4d2-8a?0-4d2-8a?0-4d2-8a0")
                        end,
                    }
                end
                goanim(this + pom1)
            end
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_kr1()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        setanim(@ --FIXME: addr
kr1, "d?1-50a0a1a2a3d1a3a2a1a0R")

        return function()
            goanim(this)
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_kr2()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        setanim(@ --FIXME: addr
kr2, "d?1-50a0a1a2a3d1a3a2a1a0R")

        return function()
            goanim(this)
        end
    end

    -- -------------------------------------------------------------
    local function prog_init_sneci()
        local pom1, pom2, pomb1, pomb2 = 0, 0, false, false

        sneci.mluvi = 0

        return function()
            for pom1 = 0, 8 do
                if sneci.mluvi ~= 0 or (--FIXME: pointer
Items[(@ --FIXME: addr
sneci) + pom1]^).dir ~= dir_no then
                    (--FIXME: pointer
Items[(@ --FIXME: addr
sneci) + pom1]^).afaze = 2
                else
                    switch((--FIXME: pointer
Items[(@ --FIXME: addr
sneci) + pom1]^).afaze){
                        [0] = function()
                            if random(100) == 1 then
                                (--FIXME: pointer
Items[(@ --FIXME: addr
sneci) + pom1]^).afaze = 1
                            end
                        end,
                        [1] = function()
                            switch(random(6)){
                                [1] = function()
                                    (--FIXME: pointer
Items[(@ --FIXME: addr
sneci) + pom1]^).afaze = 3
                                end,
                                [2] = function()
                                    (--FIXME: pointer
Items[(@ --FIXME: addr
sneci) + pom1]^).afaze = 2
                                end,
                            }
                        end,
                        [2] = function()
                            if random(10) == 1 then
                                (--FIXME: pointer
Items[(@ --FIXME: addr
sneci) + pom1]^).afaze = 1
                            end
                        end,
                        [3] = function()
                            if random(4) == 1 then
                                (--FIXME: pointer
Items[(@ --FIXME: addr
sneci) + pom1]^).afaze = 0
                            end
                        end,
                    }
                end
            end
        end
    end

    -- --------------------
    local update_table = {}
    local subinit
    subinit = prog_init_room()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_mapous()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_voko1()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_kr1()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_kr2()
    if subinit then
        table.insert(update_table, subinit)
    end
    subinit = prog_init_sneci()
    if subinit then
        table.insert(update_table, subinit)
    end
    return update_table
end
local update_table = prog_init()


-- -----------------------------------------------------------------
-- Update
-- -----------------------------------------------------------------
function prog_update()
    for key, subupdate in pairs(update_table) do
        subupdate()
    end
end

